const PC_LIGHT_THEME_PALETTE={name:"light",backgroundColor:"#FFFFFF",axisColor:"#666666",gridColor:"#E0E0E0",labelColor:"#333333",titleColor:"#333333",legendColor:"#333333",tooltipBgColor:"rgba(0,0,0,0.85)",tooltipColor:"#FFFFFF",defaultDatasetColors:["#007bff","#28a745","#dc3545","#ffc107","#17a2b8","#6f42c1","#e83e8c","#fd7e14","#20c997","#6610f2"],bar:{borderColorDarkenPercent:20},line:{},annotations:{}},PC_DARK_THEME_PALETTE={name:"dark",backgroundColor:"#22272E",axisColor:"#ADBAC7",gridColor:"#444C56",labelColor:"#F0F6FC",titleColor:"#F0F6FC",legendColor:"#F0F6FC",tooltipBgColor:"rgba(20,20,25,0.85)",tooltipColor:"#F0F6FC",defaultDatasetColors:["#58A6FF","#52D57B","#F87171","#FDB863","#6CBBEB","#B197FC","#F781BE","#FFA94D","#48D2A0","#A371F7"],bar:{borderColorDarkenPercent:0,borderColorLightenPercent:20},line:{},annotations:{}};class PureChart{constructor(t,e){let i=document.getElementById(t);if(i&&"CANVAS"===i.tagName){let s=document.querySelectorAll(`.purechart-tooltip[data-purechart-canvas-id="${t}"]`);s.forEach(t=>{t.parentNode&&t.parentNode.removeChild(t)});let a=i.parentNode,l=i.nextSibling,r={};i.hasAttribute("width")&&(r.width=i.getAttribute("width")),i.hasAttribute("height")&&(r.height=i.getAttribute("height")),i.hasAttribute("class")&&(r.class=i.getAttribute("class")),i.hasAttribute("style")&&(r.style=i.getAttribute("style")),a&&a.removeChild(i);let o=document.createElement("canvas");o.id=t,r.width&&o.setAttribute("width",r.width),r.height&&o.setAttribute("height",r.height),r.class&&(o.className=r.class),r.style&&(o.style.cssText=r.style),a&&(l?a.insertBefore(o,l):a.appendChild(o)),i=o}else if(i&&"CANVAS"!==i.tagName){console.error(`PureChart Error: Element with id "${t}" exists but is not a canvas.`),this.isValid=!1;return}if(!i||"CANVAS"!==i.tagName){console.error(`PureChart Error: Element with id "${t}" not found or is not a canvas.`),this.isValid=!1;return}this.isValid=!0,this.canvas=i,this.ctx=this.canvas.getContext("2d"),this.initialCanvasWidth=this.canvas.getAttribute("width")?parseInt(this.canvas.getAttribute("width"),10):0,this.initialCanvasHeight=this.canvas.getAttribute("height")?parseInt(this.canvas.getAttribute("height"),10):0,this.interactiveElements=[],this.interactiveLegendItems=[],this.activeTooltipData=null,this.resizeObserver=null,this.debouncedResize=null;let n={width:this.initialCanvasWidth||300,height:this.initialCanvasHeight||150,type:"bar",theme:"light",data:{},options:{autosize:!0,contourColor:null,padding:{top:20,right:20,bottom:40,left:20},yAxes:[{id:"left",position:"left",display:void 0,beginAtZero:!0,title:"",displayTitle:!0,maxTicks:5,gridLines:!0,labelFont:"10px Arial",titleFont:"12px Arial bold",color:"#666",sampleLabelForWidthEstimation:"-9,999.9"}],xAxis:{display:void 0,title:"",displayTitle:!0,gridLines:!1,labelFont:"10px Arial",titleFont:"12px Arial bold",color:"#666"},title:{display:!0,text:"",font:"18px Arial bold",color:"#333",padding:15},legend:{display:!0,position:"top",font:"12px Arial",color:"#333",padding:10,markerSize:12,markerStyle:"square"},bar:{itemSpacingFactor:.1,groupSpacingFactor:.2,defaultBorderWidth:1,borderDarkenPercent:20,topCornerRadius:0,averageLine:{display:!1,color:"#888",lineWidth:1,dashPattern:[3,3],label:{display:!0,font:"10px Arial",color:"#555",position:"above-right",padding:2,backgroundColor:"rgba(255, 255, 255, 0.7)",formatter(t){if(null==t)return"Avg: N/A";let e=t.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2});return`Avg: ${e=e.replace(/,/g," ")}`}}}},line:{pointRadius:3,lineWidth:2,tension:0,pointStyle:"circle",averageLine:{display:!1,color:"#888",lineWidth:1,dashPattern:[3,3],label:{display:!0,font:"10px Arial",color:"#555",position:"above-right",padding:2,backgroundColor:"rgba(255, 255, 255, 0.7)",formatter(t){if(null==t)return"Avg: N/A";let e=t.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2});return`Avg: ${e=e.replace(/,/g," ")}`}}}},percentageDistribution:{barHeight:20,barSpacing:3,barBorderRadius:4,labelFont:"12px Arial",labelColor:"#333",valueFont:"12px Arial bold",valueColor:"#333",showValueText:!0,labelPosition:"left",valuePosition:"right",colors:null,maxLabelWidth:100,valueTextMargin:8,sort:"none",borderWidth:1,borderColor:void 0,borderDarkenPercent:20,fillLightenPercent:void 0,valuesArePercentages:!1},pill:{min:0,max:100,zoneMin:20,zoneMax:80,value:50,borderRadius:10,pillHeight:30,colors:{mainBackground:"#e0e0e0",zoneBackground:"#a0a0a0",cursor:"#ff0000",text:"#000000",minMaxText:"#333333",valueText:"#111111"},cursorThickness:2,cursorLengthExtension:5,showMinMaxLabels:!0,showValueLabel:!0,valueLabelPosition:"below",labelFont:"10px Arial",mainLabelFont:"11px Arial",minMaxLabelPosition:"ends",pillBorderWidth:1,fillLightenPercent:70,zoneOverflowAmount:5,showZoneMinMaxLabels:!1,zoneLabelFont:"10px Arial",zoneLabelColor:"#333333",zoneLabelOffset:5,zoneLabelBackgroundPadding:2,zoneLabelBackgroundColor:"rgba(255, 255, 255, 0.7)",zoneLabelPosition:"above"},gridColor:"#e0e0e0",tooltip:{enabled:!0,backgroundColor:"rgba(0,0,0,0.85)",color:"white",font:"12px Arial",padding:"10px",borderRadius:"5px",offset:10,formatter(t){if(!t)return"";if("percentageDistribution"===t.type&&t.item)return`<div style="text-align:left;"><strong>${t.item.label}</strong><br/>Value: ${t.item.value.toLocaleString("en-US").replace(/,/g," ")}<br/>Percentage: ${t.item.percentage.toFixed(1)}%</div>`;let e=`<div style="font-weight:bold;margin-bottom:5px;text-align:left;">${t.xLabel||""}</div>`;return(t.datasets||[]).forEach(i=>{if(i&&i.dataset){let s=i.dataset.color;if(s||(s=i.dataset.borderColor||(Array.isArray(i.dataset.backgroundColor)?i.dataset.backgroundColor[0]:i.dataset.backgroundColor)),!s&&t.themePalette){let a=void 0!==i.dataset.originalIndex?i.dataset.originalIndex:0;s=t.themePalette.defaultDatasetColors[a%t.themePalette.defaultDatasetColors.length]}s=s||"#ccc";e+=`<div style="text-align:left;"><span style="display:inline-block;width:10px;height:10px;border-radius:50%;background-color:${s};margin-right:5px;"></span>${i.dataset.label||"Dataset"}: ${void 0!==i.value&&null!==i.value?i.value.toLocaleString("en-US").replace(/,/g," "):"N/A"}</div>`}}),e}},showLeadingTrailingZeroes:!1,periodHighlights:{display:!1,legendLabel:"Periods",periods:[],defaultStyle:{fillColor:"rgba(255, 0, 0, 0.1)",borderColor:"rgba(255, 0, 0, 0.3)",borderWidth:1,label:{font:"10px Arial",color:"#000000",angle:-30,position:"above",offset:5,textAlign:"center"}}}}};if(this.config=PureChart._mergeDeep(n,e),this.showPeriodHighlights=this.config.options.periodHighlights&&this.config.options.periodHighlights.display,this.config.options.autosize){let h=this.canvas.parentElement;h?(this.debouncedResize=PureChart._debounce(this._handleResize.bind(this),250),this.resizeObserver=new ResizeObserver(t=>{for(let e of t)this.debouncedResize(e.contentRect)}),this.resizeObserver.observe(h),this._handleResize(h.getBoundingClientRect())):(console.error("PureChart Autosize Error: Canvas parent element not found. Autosize disabled for this instance."),this.config.options.autosize=!1)}let c=n.options.yAxes[0];if(this.config.options.yAxis&&(!e.options?.yAxes||void 0===e.options.yAxes)){let d=this.config.options.yAxis,x=PureChart._mergeDeep({},c);this.config.options.yAxes=[PureChart._mergeDeep(x,d)],delete this.config.options.yAxis}else this.config.options.yAxes&&Array.isArray(this.config.options.yAxes)?this.config.options.yAxes=this.config.options.yAxes.map(t=>{let e=PureChart._mergeDeep({},c);return PureChart._mergeDeep(e,t)}):this.config.options.yAxes=[PureChart._mergeDeep({},c)];if(this.config.options.yAxes&&Array.isArray(this.config.options.yAxes)&&this.config.options.yAxes.forEach((t,e)=>{t.id||(t.id=0===e?"left":`yAxis-${e}`),t.position||(t.position=0===e?"left":1===e?"right":"left")}),"object"==typeof this.config.theme&&null!==this.config.theme){let g=this.config.theme.extends,f;for(let u in f="dark"===g?PC_DARK_THEME_PALETTE:PC_LIGHT_THEME_PALETTE,this.activePalette=PureChart._mergeDeep({},f),this.activePalette=PureChart._mergeDeep(this.activePalette,this.config.theme),f)void 0===this.activePalette[u]&&f.hasOwnProperty(u)&&"object"!=typeof f[u]?this.activePalette[u]=f[u]:"object"!=typeof f[u]||null===f[u]||Array.isArray(f[u])||(this.activePalette[u]||(this.activePalette[u]={}),this.activePalette[u]=PureChart._mergeDeep({},f[u],this.activePalette[u]));this.activePalette.name||(this.activePalette.name=f.name)}else"dark"===this.config.theme?this.activePalette={...PC_DARK_THEME_PALETTE}:this.activePalette={...PC_LIGHT_THEME_PALETTE};if(this.config.data&&this.config.data.datasets&&this.config.options.yAxes&&this.config.options.yAxes.length>0){let p=this.config.options.yAxes[0].id;this.config.data.datasets.forEach(t=>{void 0===t.yAxisID&&(t.yAxisID=p)})}if(this._validateConfig(),!this.isValid)return;this.canvas.width=this.config.width,this.canvas.height=this.config.height,this.isValid&&this.config.options.tooltip.enabled&&(this._createTooltipElement(),this._boundOnMouseMove=this._onMouseMove.bind(this),this._boundOnMouseOut=this._onMouseOut.bind(this),this.canvas.addEventListener("mousemove",this._boundOnMouseMove),this.canvas.addEventListener("mouseout",this._boundOnMouseOut),this.canvas.addEventListener("mouseleave",this._boundOnMouseOut)),this.config.data&&this.config.data.datasets&&this.config.data.datasets.forEach(t=>{t._hidden=!1}),this._boundOnCanvasClick=this._onCanvasClick.bind(this),this.canvas.addEventListener("click",this._boundOnCanvasClick),this._draw()}_preprocessDataForTrimming(){let t=this.config.data.labels,e=this.config.data.datasets,i=this.config.options;if(i.showLeadingTrailingZeroes||Array.isArray(e)&&e.length>1)return{labels:t,datasets:e};let s="bar"===this.config.type||"line"===this.config.type||Array.isArray(e)&&e.some(t=>"bar"===t.type||"line"===t.type);if(!s||!t||0===t.length||!Array.isArray(e)||0===e.length)return{labels:t,datasets:e};let a=1/0,l=1/0,r=t.length,o=e.filter(t=>{let e=t.type||this.config.type;return!t._hidden&&("bar"===e||"line"===e)});if(0===o.length)return{labels:t,datasets:e};let n=!0;if(o.forEach(t=>{let e=t.values||[];if(e.length!==r){a=0,l=0,n=!1;return}let i=0;for(let s=0;s<e.length;s++)if(0===e[s]||null===e[s]||void 0===e[s])i++;else{n=!1;break}i===e.length||(n=!1);let o=0;for(let h=e.length-1;h>=0;h--)if(0===e[h]||null===e[h]||void 0===e[h])o++;else break;a=Math.min(a,i),l=Math.min(l,o)}),n&&o.every(t=>(t.values||[]).every(t=>0===t||null==t))&&(a=r,l=0),a+l>=r){let h=o.some(t=>(t.values||[]).some(t=>0!==t&&null!=t));h&&(a!==r||0!==l||n?a+l>=r&&h&&(a=0,l=0):(a=0,l=0))}if(a===1/0&&(a=0),l===1/0&&(l=0),r>0&&a+l>=r&&r>0&&!o.every(t=>(t.values||[]).every(t=>0===t||null==t))&&(a=0,l=0),0===a&&0===l)return{labels:t,datasets:e};let c=t.slice(a,r-l),d=e.map((t,e)=>{let i=JSON.parse(JSON.stringify(t));i.originalIndex=e;let s=o.some(t=>t.label===i.label);if(s&&i.values){let n=i.type||this.config.type;("bar"===n||"line"===n)&&i.values.length===r&&(i.values=i.values.slice(a,r-l))}return i});return{labels:c,datasets:d}}static _debounce(t,e){let i;return function(...s){let a=this;clearTimeout(i),i=setTimeout(()=>t.apply(a,s),e)}}_handleResize(t){if(!this.isValid||!t)return;let e=Math.floor(t.width),i=Math.floor(t.height);this.initialCanvasWidth>0&&(e=Math.min(e,this.initialCanvasWidth)),this.initialCanvasHeight>0&&(i=Math.min(i,this.initialCanvasHeight)),(this.canvas.width!==e||this.canvas.height!==i)&&(this.canvas.width=e,this.canvas.height=i,this.config.width=e,this.config.height=i,this._draw())}static _calculateSMA(t,e){if(!t||e<=0||0===t.length)return[];if(t.length<e)return Array(t.length).fill(null);let i=[];for(let s=0;s<=t.length-e;s++){let a=0,l=0;for(let r=0;r<e;r++)"number"==typeof t[s+r]&&!isNaN(t[s+r])&&(a+=t[s+r],l++);i.push(l>0?a/l:null)}let o=Array(e-1).fill(null);return o.concat(i)}static _calculateDatasetAverage(t){if(!Array.isArray(t))return null;let e=t.filter(t=>"number"==typeof t&&!isNaN(t));if(0===e.length)return null;let i=e.reduce((t,e)=>t+e,0);return i/e.length}static _mergeDeep(t,e){let i=t=>t&&"object"==typeof t&&!Array.isArray(t),s={...t};return i(t)&&i(e)&&Object.keys(e).forEach(a=>{i(e[a])?a in t&&i(t[a])?s[a]=PureChart._mergeDeep(t[a],e[a]):s[a]={...e[a]}:s[a]=e[a]}),s}static async fromJSON(t,e,i={},s=null){try{let a={};s&&(a.headers={"X-CSRFToken":s});let l=await fetch(e,a);if(!l.ok)throw console.error(`PureChart Fetch Error: Status ${l.status} for URL ${e}`),Error(`PureChart Error: Failed to fetch JSON from ${e}. Status: ${l.status}`);let r=await l.json(),o=r;r&&"object"==typeof r.chart_datas&&null!==r.chart_datas&&(o=r.chart_datas);let n={};n=PureChart._mergeDeep(o,i);let h=document.getElementById(t);return h&&(!n.width&&h.width&&(n.width=h.width),!n.height&&h.height&&(n.height=h.height)),new PureChart(t,n)}catch(c){console.error("PureChart Error (fromJSON catch block):",c);let d=document.getElementById(t);if(d&&d.getContext){let x=d.getContext("2d");x.clearRect(0,0,d.width,d.height),x.font="12px Arial",x.fillStyle="red",x.textAlign="center";let g=`Error loading chart from JSON: ${String(c.message).substring(0,100)}`;String(g).split("\n").forEach((t,e)=>{x.fillText(t,d.width/2,d.height/2-(String(g).split("\n").length-1)*7+14*e)})}return null}}_validateConfig(){if("percentageDistribution"===this.config.type){if(!this.config.data||!Array.isArray(this.config.data.items)||0===this.config.data.items.length){console.error("PureChart Error (percentageDistribution): data.items array is required and non-empty."),this.isValid=!1;return}this.isValid&&this.config.data.items.forEach((t,e)=>{(null===t||"object"!=typeof t||"string"!=typeof t.label||"number"!=typeof t.value||t.value<0||isNaN(t.value))&&(console.error(`PureChart Error (percentageDistribution): Item ${e} is invalid. Must be {label: string, value: non-negative number}. Item:`,t),this.isValid=!1)}),this.isValid&&(this.config.options.percentageDistribution&&this.config.options.percentageDistribution.valuesArePercentages&&this.config.data.items.forEach((t,e)=>{"number"==typeof t.value&&!isNaN(t.value)&&(t.value<0||t.value>100)&&console.warn(`PureChart Warning (percentageDistribution): Item '${t.label||`Index ${e}`}' has value ${t.value} which is outside the expected 0-100 range when valuesArePercentages is true.`)}),this.config.options.xAxis.display=this.config.options.xAxis.display??!1,this.config.options.yAxes&&this.config.options.yAxes.length>0&&(this.config.options.yAxes[0].display=this.config.options.yAxes[0].display??!1),this.config.options.legend.display=this.config.options.legend.display??!1)}else if("pill"===this.config.type){if(!this.config.data){console.error("PureChart Error (pill): data object is required."),this.isValid=!1;return}this.config.options.xAxis.display=this.config.options.xAxis.display??!1,this.config.options.yAxes&&this.config.options.yAxes.length>0&&(this.config.options.yAxes[0].display=this.config.options.yAxes[0].display??!1),this.config.options.legend.display=this.config.options.legend.display??!1}else{if(!this.config.data||!this.config.data.labels||!this.config.data.datasets){console.error("PureChart Error (bar/line/other): data.labels and data.datasets are required."),this.isValid=!1;return}if(this.isValid&&this.config.data.datasets.forEach((t,e)=>{let i=t.type||this.config.type;"sma"===i||t.values&&Array.isArray(t.values)||(console.error(`PureChart Error (bar/line/other): Dataset ${e} ('${t.label||"Untitled"}') missing 'values' array.`),this.isValid=!1),("line"===i||"sma"===i)&&void 0===t.fill&&(t.fill=!1)}),!this.isValid)return;void 0===this.config.options.xAxis.display&&(this.config.options.xAxis.display=!0),this.config.options.yAxes&&Array.isArray(this.config.options.yAxes)&&this.config.options.yAxes.forEach(t=>{void 0===t.display&&(t.display=!0)})}}_resolveColor(t,e){if("function"==typeof t)return t(this.ctx,e);if(Array.isArray(t)&&t.length>=2){let i=this.ctx.createLinearGradient(e.x,e.y,e.x,e.y+e.h);return i.addColorStop(0,t[0]),i.addColorStop(1,t[1]),i}return t||"#007bff"}_darkenColor(t,e){if("string"!=typeof t)return"#333333";let i,s,a,l=1,r=1-e/100;if(t.startsWith("rgba")){let o=t.match(/[\d.]+/g);if(!o||!(o.length>=3))return"#333333";i=parseInt(o[0]),s=parseInt(o[1]),a=parseInt(o[2]),l=o.length>=4?parseFloat(o[3]):1}else if(t.startsWith("rgb")){let n=t.match(/\d+/g);if(!n||!(n.length>=3))return"#333333";i=parseInt(n[0]),s=parseInt(n[1]),a=parseInt(n[2])}else{if(!t.startsWith("#"))return"#333333";let h=t.slice(1);if(3===h.length&&(h=h.split("").map(t=>t+t).join("")),6!==h.length)return"#333333";{let c=parseInt(h,16);i=c>>16&255,s=c>>8&255,a=255&c}}return i=Math.max(0,Math.floor(i*r)),`rgba(${i},${s=Math.max(0,Math.floor(s*r))},${a=Math.max(0,Math.floor(a*r))},${l})`}_lightenColor(t,e){if("string"!=typeof t)return"#EEEEEE";let i,s,a,l=1,r=e/100;if(t.startsWith("rgba")){let o=t.match(/[\d.]+/g);if(!o||!(o.length>=3))return"#EEEEEE";i=parseInt(o[0]),s=parseInt(o[1]),a=parseInt(o[2]),l=o.length>=4?parseFloat(o[3]):1}else if(t.startsWith("rgb")){let n=t.match(/\d+/g);if(!n||!(n.length>=3))return"#EEEEEE";i=parseInt(n[0]),s=parseInt(n[1]),a=parseInt(n[2])}else if(t.startsWith("#")){let h=t.slice(1);if(3===h.length&&(h=h.split("").map(t=>t+t).join("")),6!==h.length)return"#EEEEEE";{let c=parseInt(h,16);i=c>>16&255,s=c>>8&255,a=255&c}}else{try{let d=this.canvas.getContext("2d");d.fillStyle=t;let x=d.fillStyle;if(x.startsWith("#")||x.startsWith("rgb"))return this._lightenColor(x,e)}catch(g){}return"#EEEEEE"}return i=Math.min(255,Math.floor(i+(255-i)*r)),`rgba(${i},${s=Math.min(255,Math.floor(s+(255-s)*r))},${a=Math.min(255,Math.floor(a+(255-a)*r))},${l})`}_getAutoColor(t,e){let i=this.config.options.percentageDistribution.colors;return i&&i[t%i.length]?i[t%i.length]:`hsl(${Math.round(t*(360/(e>1?e:2))%360)}, 70%, 55%)`}_getDrawingArea(t){let{top:e,right:i,bottom:s,left:a}={...this.config.options.padding},l=this.config.options,r=e,o=i,n=s,h=a;if(l.title.display&&l.title.text&&(this.ctx.font=l.title.font,r+=1.5*this.ctx.measureText("M").width+l.title.padding),l.legend.display&&"percentageDistribution"!==this.config.type&&"pill"!==this.config.type){this.ctx.font=l.legend.font;let c=(1.5*this.ctx.measureText("M").width+l.legend.padding)*2.1;"top"===l.legend.position?r+=c:n+=c}if("percentageDistribution"!==this.config.type&&"pill"!==this.config.type){let d=0,x=0;if(l.yAxes&&Array.isArray(l.yAxes)&&l.yAxes.forEach(t=>{if(t.display){let e=0;if(this.ctx.font=t.labelFont,e+=this.ctx.measureText(t.sampleLabelForWidthEstimation||"-9,999.9").width+10,t.displayTitle&&t.title){let i=this.ctx.font;this.ctx.font=t.titleFont,e+=1.5*this.ctx.measureText("M").width+5,this.ctx.font=i}"right"===t.position?x+=e:d+=e}}),h+=d,o+=x,l.xAxis.display&&(this.ctx.font=l.xAxis.labelFont,n+=1.5*this.ctx.measureText("M").width+5,l.xAxis.displayTitle&&l.xAxis.title)){let g=this.ctx.font;this.ctx.font=l.xAxis.titleFont,n+=1.5*this.ctx.measureText("M").width+5,this.ctx.font=g}}else this.ctx.font=l.percentageDistribution.labelFont,"left"===l.percentageDistribution.labelPosition&&(h=Math.max(h,(l.percentageDistribution.maxLabelWidth||0)+10)),this.ctx.font=l.percentageDistribution.valueFont,l.percentageDistribution.showValueText&&"right"===l.percentageDistribution.valuePosition&&(o=Math.max(o,this.ctx.measureText("100.0%").width+(l.percentageDistribution.valueTextMargin||0)+5));r=Math.max(5,r),o=Math.max(5,o),n=Math.max(5,n),h=Math.max(5,h);let f=this.canvas.width-h-o,u=this.canvas.height-r-n;return{x:h,y:r,width:f>0?f:0,height:u>0?u:0}}_createTooltipElement(){if(this.tooltipElement||!this.config.options.tooltip.enabled)return;this.tooltipElement=document.createElement("div"),this.tooltipElement.style.position="absolute",this.tooltipElement.style.visibility="hidden",this.tooltipElement.style.pointerEvents="none",this.tooltipElement.style.zIndex="100",this.tooltipElement.classList.add("purechart-tooltip"),this.canvas&&this.canvas.id&&this.tooltipElement.setAttribute("data-purechart-canvas-id",this.canvas.id);let t=this.config.options.tooltip;this.tooltipElement.style.backgroundColor=t.backgroundColor,this.tooltipElement.style.color=t.color,this.tooltipElement.style.font=t.font,this.tooltipElement.style.padding=t.padding,this.tooltipElement.style.borderRadius=t.borderRadius,this.tooltipElement.style.boxShadow="0 2px 5px rgba(0,0,0,0.2)",document.body.appendChild(this.tooltipElement)}_draw(){if(!this.isValid)return;if(!this.activePalette){if(this.config&&this.config.theme){if("dark"===this.config.theme)this.activePalette={...PC_DARK_THEME_PALETTE};else if("object"==typeof this.config.theme&&null!==this.config.theme){let t=this.config.theme.extends,e;for(let i in e="dark"===t?PC_DARK_THEME_PALETTE:PC_LIGHT_THEME_PALETTE,this.activePalette=PureChart._mergeDeep({},e,this.config.theme),e)void 0===this.activePalette[i]&&e.hasOwnProperty(i)&&"object"!=typeof e[i]?this.activePalette[i]=e[i]:"object"!=typeof e[i]||null===e[i]||Array.isArray(e[i])||(this.activePalette[i]||(this.activePalette[i]={}),this.activePalette[i]=PureChart._mergeDeep({},e[i],this.activePalette[i]));this.activePalette.name||(this.activePalette.name=e.name)}else this.activePalette={...PC_LIGHT_THEME_PALETTE}}else console.error("PureChart: Cannot initialize activePalette in _draw due to missing config or theme. Using light theme as emergency fallback."),this.activePalette={...PC_LIGHT_THEME_PALETTE}}this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.textBaseline="middle",this.interactiveElements=[];let s=this._preprocessDataForTrimming();if(this._currentDrawingData=s,s.labels&&0===s.labels.length&&("bar"===this.config.type||"line"===this.config.type||this.config.data.datasets.some(t=>"bar"===t.type||"line"===t.type))&&!0!==this.config.options.showLeadingTrailingZeroes){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.config.options.title.display&&this.config.options.title.text&&this._drawTitle(),this.ctx.font=this.config.options.font||"12px Arial",this.ctx.fillStyle=this.activePalette&&this.activePalette.labelColor||"#333",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText("No data to display",this.canvas.width/2,this.canvas.height/2);return}if(this._preprocessDatasetValues(),this.drawArea=this._getDrawingArea(s.labels),this.drawArea.width<=0||this.drawArea.height<=0){console.warn("PureChart Warning: Drawing area too small."),this.ctx.font="12px Arial",this.ctx.fillStyle="#333",this.ctx.textAlign="center",this.ctx.fillText("Drawing area too small.",this.canvas.width/2,this.canvas.height/2);return}if("percentageDistribution"!==this.config.type&&(this._calculateScale(s.datasets),!this.isValid)){console.error("PureChart: Scale calculation failed."),this.ctx.font="12px Arial",this.ctx.fillStyle="red",this.ctx.textAlign="center",this.ctx.fillText("Error: Scale calculation failed.",this.canvas.width/2,this.canvas.height/2);return}this.config.options.title.display&&this.config.options.title.text&&this._drawTitle(),"percentageDistribution"===this.config.type?this._drawPercentageBarChart():(this.config.options.legend.display&&this._drawLegend(),this._drawAxesAndGrid(s.labels,s.datasets),this._drawPeriodHighlights(),this.config.options.yAxes&&this.config.options.yAxes.length>0&&this.yAxisScales&&Object.keys(this.yAxisScales).length>0&&this._drawAnnotations(),this._drawBarChart(s.labels,s.datasets),this._drawLineChart(s.labels,s.datasets),this._drawAverageLines(s.datasets)),"pill"===this.config.type&&this._drawPillChart()}_drawAverageLines(t){let e={datasets:t};e&&e.datasets&&"percentageDistribution"!==this.config.type&&this.yAxisScales&&(this.ctx.save(),e.datasets.forEach(t=>{"number"==typeof t.originalIndex&&t.originalIndex;let e=t.type||this.config.type;if(t._hidden||"percentageDistribution"===e||"sma"===e)return;let i=t.yAxisID||(this.config.options.yAxes&&this.config.options.yAxes.length>0?this.config.options.yAxes[0].id:null);if(!i)return;let s=this.yAxisScales[i];if(!s||!s.scale||s.scale<=0||!isFinite(s.scale)||!s.axisConfig.display)return;let a=this.config.options[e]&&this.config.options[e].averageLine?this.config.options[e].averageLine:{},l=t.averageLine||{},r=PureChart._mergeDeep(a,l);if(!r.display)return;let o=PureChart._calculateDatasetAverage(t.values);if(null===o)return;let n=this.drawArea.y+this.drawArea.height-(o-(s.min||0))*(s.scale||1);if(n=Math.max(this.drawArea.y,Math.min(n,this.drawArea.y+this.drawArea.height)),this.ctx.save(),this.ctx.beginPath(),this.ctx.moveTo(this.drawArea.x,n),this.ctx.lineTo(this.drawArea.x+this.drawArea.width,n),this.ctx.strokeStyle=r.color,this.ctx.lineWidth=r.lineWidth,Array.isArray(r.dashPattern)&&r.dashPattern.length>0&&this.ctx.setLineDash(r.dashPattern),this.ctx.stroke(),Array.isArray(r.dashPattern)&&r.dashPattern.length>0&&this.ctx.setLineDash([]),this.ctx.restore(),r.label&&r.label.display&&r.label.formatter){this.ctx.save();let h=r.label,c="function"==typeof h.formatter?h.formatter(o):String(o);this.ctx.font=h.font,this.ctx.fillStyle=h.color;let d,x,g=h.padding||0,f=this.ctx.measureText(c),u=parseInt(this.ctx.font.match(/(\d+)px/)?.[1]||"10"),p="right",b="bottom";if(d=this.drawArea.x+this.drawArea.width-g,x=n-g,"above-left"===h.position?(p="left",d=this.drawArea.x+g):"below-left"===h.position?(p="left",b="top",d=this.drawArea.x+g,x=n+g):"below-right"===h.position&&(p="right",b="top",d=this.drawArea.x+this.drawArea.width-g,x=n+g),this.ctx.textAlign=p,this.ctx.textBaseline=b,h.backgroundColor){let $=f.width+2*g,y=d,m=x;y="right"===p?d-f.width-g:"center"===p?d-f.width/2-g:d-g,m="bottom"===b?x-u-g:"middle"===b?x-u/2-g:x-g,this.ctx.fillStyle=h.backgroundColor,this.ctx.fillRect(y,m,$,u+2*g),this.ctx.fillStyle=h.color}this.ctx.fillText(c,d,x),this.ctx.restore()}}),this.ctx.restore())}_drawTitle(){let{text:t,font:e,color:i,padding:s}=this.config.options.title;this.ctx.save(),this.ctx.font=e,this.ctx.fillStyle=i,this.ctx.textAlign="center",this.ctx.textBaseline="top",this.ctx.fillText(t,this.canvas.width/2,s),this.ctx.restore()}_drawLegend(){let{data:t,options:e}=this.config,{legend:i}=e;if(!t.datasets||0===t.datasets.length)return;this.ctx.save(),this.interactiveLegendItems=[],this.ctx.font=i.font,this.ctx.fillStyle=i.color,this.ctx.textAlign="left",this.ctx.textBaseline="middle";let s=i.markerSize,a=Math.max(s,1.2*this.ctx.measureText("M").width),l,r,o=e.padding.top;if(e.title.display&&e.title.text){let n=this.ctx.font;this.ctx.font=e.title.font,o=1.5*this.ctx.measureText("M").width+e.title.padding+e.padding.top,this.ctx.font=n}r="top"===i.position?o+i.padding+a/2:this.canvas.height-e.padding.bottom-i.padding-a/2;let h=t.datasets.map((t,e)=>({label:t.label||`Dataset ${e+1}`,color:t.borderColor||(Array.isArray(t.backgroundColor)?t.backgroundColor[0]:t.backgroundColor)||"#ccc",textWidth:this.ctx.measureText(t.label||`Dataset ${e+1}`).width,dataset:t,datasetIndex:e}));if(this.config.options.periodHighlights&&this.config.options.periodHighlights.periods&&this.config.options.periodHighlights.periods.length>0&&this.config.options.periodHighlights.legendLabel){let c=this.config.options.periodHighlights.legendLabel,d=this.config.options.periodHighlights.defaultStyle?.fillColor||"#888888";h.push({label:c,color:d,textWidth:this.ctx.measureText(c).width,isPeriodToggle:!0,dataset:{_hidden:!this.showPeriodHighlights}})}let x=h.reduce((t,e)=>t+s+5+e.textWidth+15,0)-15;l=Math.max(this.drawArea.x,this.drawArea.x+(this.drawArea.width-x)/2);let g=this.drawArea.x+this.drawArea.width;h.forEach(t=>{let e=l,o=s+5+t.textWidth+15;l+o>g&&l>Math.max(this.drawArea.x,this.drawArea.x+(this.drawArea.width-x)/2)&&(r+=a+5,l=Math.max(this.drawArea.x,this.drawArea.x+(this.drawArea.width-x)/2)),l<this.drawArea.x&&(l=this.drawArea.x);let n=l,h=n+s+5,c={x:n,y:r-a/2,w:o,h:a};this.interactiveLegendItems.push({rect:c,dataset:t.dataset,datasetIndex:t.datasetIndex,isPeriodToggle:t.isPeriodToggle||!1}),this.ctx.fillStyle=t.color,"circle"===i.markerStyle?(this.ctx.beginPath(),this.ctx.arc(n+s/2,r,s/2,0,2*Math.PI),this.ctx.fill()):this.ctx.fillRect(n,r-s/2,s,s);let d=this.ctx.fillStyle;if(t.dataset._hidden?this.ctx.fillStyle="#aaa":this.ctx.fillStyle=i.color,this.ctx.fillText(t.label,h,r),t.dataset._hidden){let f=t.textWidth;this.ctx.beginPath(),this.ctx.moveTo(h,r),this.ctx.lineTo(h+f,r),this.ctx.strokeStyle="#aaa",this.ctx.lineWidth=1,this.ctx.stroke()}this.ctx.fillStyle=d,l+=o}),this.ctx.restore()}_onCanvasClick(t){if(!this.interactiveLegendItems||0===this.interactiveLegendItems.length)return;let e=this._getMousePos(t),i=!1;for(let s of this.interactiveLegendItems)if(e.x>=s.rect.x&&e.x<=s.rect.x+s.rect.w&&e.y>=s.rect.y&&e.y<=s.rect.y+s.rect.h&&(i=!0,s.isPeriodToggle?(this.showPeriodHighlights=!this.showPeriodHighlights,s.dataset&&(s.dataset._hidden=!this.showPeriodHighlights)):s.dataset?s.dataset._hidden=!s.dataset._hidden:i=!1,i))break;i&&this._draw()}_calculateScale(t){let{options:e}=this.config,i={datasets:t};if(this.yAxisScales={},!e.yAxes||!Array.isArray(e.yAxes)||0===e.yAxes.length){console.warn("PureChart _calculateScale: No yAxes configured. Chart may not render correctly."),this.minValue=0,this.maxValue=1,this.yScale=this.drawArea.height>0?this.drawArea.height:1,this.yAxisScales.default={min:0,max:1,scale:this.yScale,axisConfig:{id:"default",display:!0,beginAtZero:!0,position:"left"}},this.isValid=!1;return}if(e.yAxes.forEach(t=>{let e=t.id,s=[];i.datasets&&i.datasets.length>0&&i.datasets.forEach(t=>{t.yAxisID===e&&!t._hidden&&t.values&&Array.isArray(t.values)&&t.values.length>0&&(s=s.concat(t.values.filter(t=>"number"==typeof t&&!isNaN(t))))});let a,l;if(0===s.length)a=0,l=1;else{let r=Math.min(...s),o=Math.max(...s);t.beginAtZero?(a=Math.min(0,r),l=Math.max(0,o)):(a=r,l=o)}if(a===l){if(0===a)l=1;else{let n=Math.abs(.1*l)||1;l+=n,t.beginAtZero?a=Math.min(0,a-n):a-=n}}a===l&&(l+=1);let h;(!isFinite(h=this.drawArea.height<=0?1:l-a==0?1:this.drawArea.height/(l-a))||h<=0)&&(console.error(`PureChart _calculateScale: Invalid yScale (${h}) calculated for yAxis ID '${e}'. Defaulting to 1.`),h=1),this.yAxisScales[e]={min:a,max:l,scale:h,axisConfig:t}}),e.yAxes.length>0){let s=e.yAxes[0].id,a=this.yAxisScales[s];a?(this.minValue=a.min,this.maxValue=a.max,this.yScale=a.scale):(console.error("PureChart _calculateScale: Failed to get scale for the first Y-axis for backward compatibility."),this.minValue=0,this.maxValue=1,this.yScale=1)}else this.minValue=0,this.maxValue=1,this.yScale=1}_drawAxesAndGrid(t,e){let{options:i}=this.config,s={labels:t,datasets:e};this.ctx.save(),this.ctx.lineWidth=1,this.ctx.font=i.font;let a=null;if(i.yAxes&&Array.isArray(i.yAxes)){for(let l of i.yAxes)if(l.display&&l.gridLines){a=l.id;break}}this.yAxisScales&&"object"==typeof this.yAxisScales&&Object.values(this.yAxisScales).forEach(t=>{let{axisConfig:e,min:s,max:l,scale:r}=t;if(!e.display||this.drawArea.height<=0||!isFinite(r)||r<=0)return;let o="right"===e.position,n=o?this.drawArea.x+this.drawArea.width:this.drawArea.x;this.ctx.strokeStyle=e.color||this.activePalette.axisColor,this.ctx.fillStyle=e.color||this.activePalette.axisColor,this.ctx.font=e.labelFont,this.ctx.beginPath(),this.ctx.moveTo(n,this.drawArea.y),this.ctx.lineTo(n,this.drawArea.y+this.drawArea.height),this.ctx.stroke(),this.ctx.textAlign=o?"left":"right",this.ctx.textBaseline="middle";let h=Math.max(2,e.maxTicks||5);if(void 0!==l&&void 0!==s&&l-s!=0)for(let c=0;c<=h;c++){let d=l-c*(l-s)/h,x=this.drawArea.y+c*this.drawArea.height/h;if(x>=this.drawArea.y-1&&x<=this.drawArea.y+this.drawArea.height+1){let g=o?n+8:n-8,f=d.toLocaleString("en-US");f=f.replace(/,/g," "),this.ctx.fillText(f,g,x)}e.id===a&&c>0&&c<h&&x>this.drawArea.y&&x<this.drawArea.y+this.drawArea.height&&(this.ctx.save(),this.ctx.strokeStyle=i.gridColor||this.activePalette.gridColor,this.ctx.lineWidth=.5,this.ctx.beginPath(),this.ctx.moveTo(this.drawArea.x+1,x),this.ctx.lineTo(this.drawArea.x+this.drawArea.width,x),this.ctx.stroke(),this.ctx.restore())}else if(void 0!==l){let u=l.toLocaleString("en-US");u=u.replace(/,/g," "),this.ctx.fillText(u,o?n+8:n-8,this.drawArea.y+this.drawArea.height/2)}if(e.displayTitle&&e.title){this.ctx.save(),this.ctx.font=e.titleFont,this.ctx.textAlign="center",this.ctx.textBaseline="middle";let p=this.ctx.font;this.ctx.font=e.labelFont;let b=e.sampleLabelForWidthEstimation||(void 0!==l?l.toLocaleString():"-9,999.9"),$=this.ctx.measureText(b).width;this.ctx.font=p;let y=1.5*this.ctx.measureText("M").width,m;o?(m=n+$+8+y/2+5,this.ctx.translate(m,this.drawArea.y+this.drawArea.height/2),this.ctx.rotate(Math.PI/2)):(m=n-$-8-y/2-5,this.ctx.translate(m,this.drawArea.y+this.drawArea.height/2),this.ctx.rotate(-Math.PI/2)),this.ctx.fillText(e.title,0,0),this.ctx.restore()}});let r=i.xAxis,o=null,n=null;if(a&&this.yAxisScales[a]&&this.yAxisScales[a].axisConfig.display)o=(n=this.yAxisScales[a]).axisConfig;else if(i.yAxes&&i.yAxes.length>0){for(let h of i.yAxes)if(h.display&&this.yAxisScales[h.id]){n=this.yAxisScales[h.id],o=h;break}}let c=this.drawArea.y+this.drawArea.height;if(n&&n.scale>0){let d=n.min,x=n.max,g=n.scale;if(d<=0&&x>=0){let f=this.drawArea.y+this.drawArea.height-(0-d)*g;c=Math.max(this.drawArea.y,Math.min(f,this.drawArea.y+this.drawArea.height))}else x<0&&o&&o.beginAtZero&&(c=this.drawArea.y)}if(r.display&&this.drawArea.width>0){if(this.ctx.strokeStyle=r.color||this.activePalette.axisColor,this.ctx.lineWidth=1,this.ctx.beginPath(),this.ctx.moveTo(this.drawArea.x,c),this.ctx.lineTo(this.drawArea.x+this.drawArea.width,c),this.ctx.stroke(),s.labels&&s.labels.length>0){this.ctx.fillStyle=r.labelColor||this.activePalette.labelColor||this.activePalette.axisColor,this.ctx.font=r.labelFont,this.ctx.textBaseline="top";let u=s.labels,p=u.length,b=void 0===r.forceShowFirstAndLastLabel||r.forceShowFirstAndLastLabel,$=r.maxLabelsToShow,y=void 0!==r.minSpacingBetweenLabels?r.minSpacingBetweenLabels:5,m=r.labelYOffset||8,v=c+m;if(this.drawArea.width,void 0===$&&p>0){let A=0,w=this.ctx.font;this.ctx.font=r.labelFont,u.forEach(t=>{A+=this.ctx.measureText(String(t)).width}),this.ctx.font=w;let C=p>0?A/p:0;$=Math.max(1,$=C+y>0?Math.floor(this.drawArea.width/(C+y)):p)}else void 0===$&&0===p&&($=0);let _=[];if(p>0&&$>0){if(p<=$)_=u.map((t,e)=>e);else{b&&(_.push(0),p>1&&_.push(p-1));let P=$-_.length;if(P>0){let E=[];for(let T=0;T<p;T++)_.includes(T)||E.push(T);if(E.length>0){let S=Math.max(1,Math.floor(E.length/P));for(let D=0;D<E.length&&_.length<$;D+=S)_.includes(E[D])||_.push(E[D])}}_=[...new Set(_)].sort((t,e)=>t-e)}}if("bar"===this.config.type){this.ctx.textAlign="center",this.ctx.textBaseline="top",this.ctx.fillStyle=r.labelColor||this.activePalette.labelColor||this.activePalette.axisColor,this.ctx.font=r.labelFont;let k=s.labels.length;if(k>0){let L=this.drawArea.width/k,R=L*(this.config.options.bar.groupSpacingFactor||.2),F=L-R;for(let M=0;M<k;M++){let I=this.drawArea.x+M*L+R/2,B=I+F/2,H=String(s.labels[M]);this.ctx.font=r.labelFont,this.ctx.textAlign="center",this.ctx.textBaseline="top";let W=this.ctx.measureText(H),z=r.labelFont.match(/(\d+)px/),O=z?parseInt(z[1],10):10,V={x:3,y:1},N=W.width+2*V.x,j=O+2*V.y,Y=B-W.width/2-V.x,G=v-V.y,Z=this.ctx.fillStyle;this.ctx.fillStyle=this.activePalette&&this.activePalette.backgroundColor?this.activePalette.backgroundColor:"white",this.ctx.fillRect(Y,G,N,j),this.ctx.fillStyle=Z,this.ctx.fillText(H,B,v)}}}else if(s.labels&&s.labels.length>0&&_.length>0){this.ctx.font=r.labelFont;let U=_.map(t=>{let e=String(u[t]);return{text:e,width:this.ctx.measureText(e).width,originalIndex:t}}).filter(t=>t.width>0);if(U.length>0){let X=[...U],q=[],K=0,J=void 0!==r.minSpacingBetweenLabels?r.minSpacingBetweenLabels:5;for(;;){if(0===X.length){q=[];break}let Q=X.reduce((t,e)=>t+e.width,0);if(X.length<=1){q=[...X];break}let tt=X.length-1;if((K=(this.drawArea.width-Q)/tt)>=J){q=[...X];break}{if(X.length<=2&&b||X.length<=1){q=[...X];break}let te=Math.floor(X.length/2);if(b&&X.length>2&&(0===te?te=1:te===X.length-1&&(te=X.length-2)),0===te&&2===X.length&&b||(te>=X.length-1&&X.length>2&&b?te=X.length-2:0===te&&X.length),X.length>0&&te<X.length&&te>=0){if(b&&2===X.length&&U.length>=2&&X[0].originalIndex===U[0].originalIndex&&X[1].originalIndex===U[U.length-1].originalIndex){q=[...X];break}X.splice(te,1)}else{q=[...X];break}}}if(q.length>0){if(this.ctx.textAlign="center",this.ctx.textBaseline="top",this.ctx.fillStyle=r.labelColor||this.activePalette.labelColor||this.activePalette.axisColor,this.ctx.font=r.labelFont,1===q.length){let ti=q[0],ts=this.drawArea.x+this.drawArea.width/2;ti.width,this.drawArea.width,ts=Math.min(ts=Math.max(ts,this.drawArea.x+ti.width/2),this.drawArea.x+this.drawArea.width-ti.width/2),ti.width>this.drawArea.width&&(ts=this.drawArea.x+this.drawArea.width/2),this.ctx.fillText(ti.text,ts,v)}else{let ta=q.reduce((t,e)=>t+e.width,0),tl=Math.max(J,(this.drawArea.width-ta)/(q.length-1)),tr=this.drawArea.x;q.length,this.drawArea.width,q.forEach((t,e)=>{let i=tr+t.width/2,s=t.text,a=t.width,l=r.labelFont.match(/(\d+)px/),o=l?parseInt(l[1],10):10,n={x:3,y:1},h=a+2*n.x,c=o+2*n.y,d=i-a/2-n.x,x=v-n.y,g=this.ctx.fillStyle;this.ctx.fillStyle=this.activePalette&&this.activePalette.backgroundColor?this.activePalette.backgroundColor:"white",this.ctx.fillRect(d,x,h,c),this.ctx.fillStyle=g,this.ctx.fillText(s,i,v),tr+=a+tl})}}}}}r.displayTitle&&r.title&&(this.ctx.font=r.titleFont,this.ctx.fillStyle=r.titleColor||this.activePalette.titleColor||this.activePalette.axisColor,this.ctx.textAlign="center",this.ctx.textBaseline="bottom",this.ctx.fillText(r.title,this.drawArea.x+this.drawArea.width/2,this.canvas.height-i.padding.bottom/2))}this.ctx.restore()}_fillRoundRect(t,e,i,s,a,l){if(s<=0||a<=0)return;let r=0,o=0,n=0,h=0;"number"==typeof l?r=o=n=h=Math.max(0,l):"object"==typeof l&&null!==l&&(r=Math.max(0,l.tl||0),o=Math.max(0,l.tr||0),n=Math.max(0,l.br||0),h=Math.max(0,l.bl||0));let c=s/2,d=a/2;if(r=Math.min(r,c,d),o=Math.min(o,c,d),n=Math.min(n,c,d),h=Math.min(h,c,d),r<=0&&o<=0&&n<=0&&h<=0){t.fillRect(e,i,s,a);return}t.beginPath(),t.moveTo(e+r,i),t.lineTo(e+s-o,i),o>0&&t.arcTo(e+s,i,e+s,i+o,o),t.lineTo(e+s,i+a-n),n>0&&t.arcTo(e+s,i+a,e+s-n,i+a,n),t.lineTo(e+h,i+a),h>0&&t.arcTo(e,i+a,e,i+a-h,h),t.lineTo(e,i+r),r>0&&t.arcTo(e,i,e+r,i,r),t.closePath(),t.fill()}_strokeRoundRect(t,e,i,s,a,l,r=1){if(s<=0||a<=0||r<=0)return;let o=0,n=0,h=0,c=0;"number"==typeof l?o=n=h=c=Math.max(0,l):"object"==typeof l&&null!==l&&(o=Math.max(0,l.tl||0),n=Math.max(0,l.tr||0),h=Math.max(0,l.br||0),c=Math.max(0,l.bl||0));let d=s/2,x=a/2;if(o=Math.min(o,d,x),n=Math.min(n,d,x),h=Math.min(h,d,x),c=Math.min(c,d,x),o<=0&&n<=0&&h<=0&&c<=0){t.strokeRect(e,i,s,a);return}t.beginPath(),t.moveTo(e+o,i),t.lineTo(e+s-n,i),n>0&&t.arcTo(e+s,i,e+s,i+n,n),t.lineTo(e+s,i+a-h),h>0&&t.arcTo(e+s,i+a,e+s-h,i+a,h),t.lineTo(e+c,i+a),c>0&&t.arcTo(e,i+a,e,i+a-c,c),t.lineTo(e,i+o),o>0&&t.arcTo(e,i,e+o,i,o),t.closePath(),t.stroke()}_drawPercentageBarChart(){if(!this.config.data||!Array.isArray(this.config.data.items)){console.error("PureChart Error (_drawPercentageBarChart): data.items is missing or not an array."),this.ctx.font="12px Arial",this.ctx.fillStyle="red",this.ctx.textAlign="center",this.ctx.fillText("Error: Invalid data for percentage chart.",this.canvas.width/2,this.canvas.height/2);return}let{items:t}=this.config.data,e=this.config.options.percentageDistribution,i=this.drawArea,s=[...t];if(e.valuesArePercentages)s.forEach(t=>{let e="number"!=typeof t.value||isNaN(t.value)?0:t.value;t.percentage=Math.max(0,Math.min(100,e))});else{let a=s.reduce((t,e)=>t+("number"!=typeof e.value||isNaN(e.value)?0:e.value),0);s.forEach(t=>{let e="number"!=typeof t.value||isNaN(t.value)?0:t.value;t.percentage=0===a?0:e/a*100})}"ascending"===e.sort?s.sort((t,e)=>t.value-e.value):"descending"===e.sort&&s.sort((t,e)=>e.value-t.value);let l=i.x,r=i.width;if(r<=0){console.warn(`PureChart Warning: Not enough width for percentage bar drawing area. PlotAreaWidth: ${r}`),this.ctx.font="12px Arial",this.ctx.fillStyle="orange",this.ctx.textAlign="center",this.ctx.fillText("Not enough space for bars.",this.canvas.width/2,this.canvas.height/2);return}let o=i.y+e.barSpacing/2;s.forEach((t,a)=>{if(o+e.barHeight>i.y+i.height+e.barSpacing)return;let n=this._getAutoColor(a,s.length),h=Math.max(0,t.percentage/100*r),c=o+e.barHeight/2,d=e.fillLightenPercent,x=void 0!==e.borderWidth?e.borderWidth:1,g="string"==typeof this.config.options.contourColor&&this.config.options.contourColor?this.config.options.contourColor:null;if(g)this.ctx.fillStyle=this.activePalette.backgroundColor,this.ctx.strokeStyle=g,this.ctx.lineWidth=x,h>0&&(this._fillRoundRect(this.ctx,l,o,h,e.barHeight,e.barBorderRadius),this._strokeRoundRect(this.ctx,l,o,h,e.barHeight,e.barBorderRadius,this.ctx.lineWidth));else if(void 0!==d&&d>0&&"number"==typeof d){let f=n,u=this._lightenColor(n,d);h>0&&(this.ctx.fillStyle=this._resolveColor(u,{x:l,y:o,w:h,h:e.barHeight}),this._fillRoundRect(this.ctx,l,o,h,e.barHeight,e.barBorderRadius),x>0&&(this.ctx.strokeStyle=this._resolveColor(f,{x:l,y:o,w:h,h:e.barHeight}),this.ctx.lineWidth=x,this._strokeRoundRect(this.ctx,l,o,h,e.barHeight,e.barBorderRadius,x)))}else{let p=n;if(this.ctx.fillStyle=this._resolveColor(p,{x:l,y:o,w:h,h:e.barHeight}),this._fillRoundRect(this.ctx,l,o,h,e.barHeight,e.barBorderRadius),x>0){let b=e.borderColor;if(void 0===b){let $=this._resolveColor(p,{x:l,y:o,w:h,h:e.barHeight});b="string"==typeof $?this._darkenColor($,void 0!==e.borderDarkenPercent?e.borderDarkenPercent:20):"#333333"}b&&"transparent"!==b&&(this.ctx.strokeStyle=b,this.ctx.lineWidth=x,this._strokeRoundRect(this.ctx,l,o,h,e.barHeight,e.barBorderRadius,x))}}if("left"===e.labelPosition&&(this.ctx.font=e.labelFont,this.ctx.fillStyle=e.labelColor,this.ctx.textAlign="right",this.ctx.textBaseline="middle",this.ctx.fillText(t.label,l-10,c,e.maxLabelWidth||void 0)),"insideStart"===e.labelPosition&&(this.ctx.font=e.labelFont,this.ctx.fillStyle=e.labelColor,this.ctx.textAlign="left",this.ctx.textBaseline="middle",this.ctx.measureText(t.label).width+10<h&&this.ctx.fillText(t.label,l+5+(e.barBorderRadius/2||0),c)),e.showValueText){this.ctx.font=e.valueFont,this.ctx.fillStyle=e.valueColor,this.ctx.textBaseline="middle";let y=`${t.percentage.toFixed(1)}%`;"right"===e.valuePosition?(this.ctx.textAlign="left",this.ctx.fillText(y,l+h+(e.valueTextMargin||0),c)):"insideEnd"===e.valuePosition&&(this.ctx.textAlign="right",this.ctx.measureText(y).width+10<h&&this.ctx.fillText(y,l+h-5-(e.barBorderRadius/2||0),c))}let m={x:l,y:o,w:h,h:e.barHeight};this.interactiveElements.push({type:"percentageDistribution",rect:m,item:{...t},index:a}),o+=e.barHeight+e.barSpacing})}_getBarRect(t,e,i,s,a,l){let r=this.config.options.bar,o=r.itemSpacingFactor*(s>1?s-1:0),n=a*(1-o)/s,h=e*(n+n*r.itemSpacingFactor),c=parseFloat(t)||0,d=l.min||0,x=l.scale||1,g=this.drawArea.y+this.drawArea.height-(0-d)*x,f=Math.abs(c*x),u;return(u=c>=0?g-f:g)<this.drawArea.y&&(f-=this.drawArea.y-u,u=this.drawArea.y),u+f>this.drawArea.y+this.drawArea.height&&(f=this.drawArea.y+this.drawArea.height-u),f<0&&(f=0),{x:h,y:u,w:n>0?n:0,h:f}}_drawBarChart(t,e){let{options:i,type:s}=this.config,a={labels:t,datasets:e};if(!a.labels||0===a.labels.length||!a.datasets||0===a.datasets.length)return;let l=a.datasets.filter(t=>{let e=t.type||s;return!t._hidden&&"bar"===e});if(0===l.length)return;let r=a.labels.length,o=l.length,n=this.drawArea.width/r,h=n*i.bar.groupSpacingFactor,c=n-h;if(c<=0&&o>0){console.warn("PureChart: Not enough width for bar groups.");return}a.labels.forEach((t,e)=>{let s=this.drawArea.x+e*n+h/2;l.forEach((a,l)=>{let r=a.yAxisID||(i.yAxes&&i.yAxes.length>0?i.yAxes[0].id:null);if(!r){console.warn(`PureChart _drawBarChart: Dataset '${a.label}' has no yAxisID.`);return}let n=this.yAxisScales[r];if(!n||!n.scale||n.scale<=0||!isFinite(n.scale)){console.warn(`PureChart _drawBarChart: Invalid Y-axis scale for dataset '${a.label}' on yAxisID '${r}'. Skipping bar.`);return}let h="number"==typeof a.originalIndex?a.originalIndex:0,d=a.values&&a.values.length>e&&"number"==typeof a.values[e]&&!isNaN(a.values[e])?a.values[e]:0,x=this._getBarRect(d,l,e,o,c,n);if(x.w<=0)return;let g=s+x.x,f={x:g,y:x.y,w:x.w,h:x.h},u="string"==typeof i.contourColor&&i.contourColor?i.contourColor:null,p=a.borderWidth;if(void 0===p&&(p=void 0!==i.bar.defaultBorderWidth?i.bar.defaultBorderWidth:1),this.ctx.lineWidth=p,u)this.ctx.fillStyle=this.activePalette.backgroundColor,this.ctx.strokeStyle=u;else{let b=this.activePalette.defaultDatasetColors[h%this.activePalette.defaultDatasetColors.length],$=a.backgroundColor||b,y=this._resolveColor($,f);this.ctx.fillStyle=y;let m=a.borderColor;!m&&p>0&&(m="string"==typeof y?this._darkenColor(y,void 0!==i.bar.borderDarkenPercent?i.bar.borderDarkenPercent:20):this.activePalette.axisColor),this.ctx.strokeStyle=m||"transparent"}let v=i.bar.topCornerRadius||0;if(v>0&&f.h>0){let A;A=d>=0?{tl:v,tr:v,bl:0,br:0}:{tl:0,tr:0,bl:v,br:v},this._fillRoundRect(this.ctx,f.x,f.y,f.w,f.h,A),p>0&&"transparent"!==this.ctx.strokeStyle&&this._strokeRoundRect(this.ctx,f.x,f.y,f.w,f.h,A,p)}else f.h>0&&(this.ctx.fillRect(f.x,f.y,f.w,f.h),p>0&&"transparent"!==this.ctx.strokeStyle&&this.ctx.strokeRect(f.x,f.y,f.w,f.h));this.interactiveElements.push({type:"bar",rect:f,xLabel:t,dataset:a,value:d,datasetIndex:h,pointIndex:e})})})}_getControlPointsForSegment(t,e,i,s,a){a="number"==typeof a&&isFinite(a)?a:0;let l=(i.x-t.x)*a,r=(i.y-t.y)*a,o=(s.x-e.x)*a,n=(s.y-e.y)*a;return{cp1:{x:e.x+l,y:e.y+r},cp2:{x:i.x-o,y:i.y-n}}}_drawLineChart(t,e){let{options:i,type:s}=this.config,a=i.line,l={labels:t,datasets:e};l.datasets&&0!==l.datasets.length&&l.datasets.forEach(t=>{let e="number"==typeof t.originalIndex?t.originalIndex:0,r=t.type||s;if(t._hidden||"line"!==r&&"sma"!==r||!t.values||!Array.isArray(t.values)||t.values.length<1)return;this.ctx.save();let o=t.yAxisID||(i.yAxes&&i.yAxes.length>0?i.yAxes[0].id:null);if(!o){console.warn(`PureChart _drawLineChart: Dataset '${t.label}' has no yAxisID.`),this.ctx.restore();return}let n=this.yAxisScales[o];if(!n||!n.scale||n.scale<=0||!isFinite(n.scale)){console.warn(`PureChart _drawLineChart: Invalid Y-axis scale for dataset '${t.label}' on yAxisID '${o}'. Skipping line.`),this.ctx.restore();return}let h=t.values.map((i,r)=>{let o=this._getPointPosition(i,r,n,l.labels.length,s);return this.interactiveElements.push({type:"point",pos:o,radius:void 0!==t.pointRadius?t.pointRadius:void 0!==a.pointRadius?a.pointRadius:3,xLabel:l.labels&&void 0!==l.labels[r]?String(l.labels[r]):`Index ${r}`,dataset:t,value:i,datasetIndex:e,pointIndex:r}),o});if(0===h.length){this.ctx.restore();return}let c=void 0!==t.tension?t.tension:a.tension,d=void 0!==t.lineWidth?t.lineWidth:a.lineWidth,x="string"==typeof i.contourColor&&i.contourColor?i.contourColor:null;if(t.fill&&h.length>1){this.ctx.beginPath();let g=this.drawArea.y+this.drawArea.height-(0-(n.min||0))*(n.scale||1),f=Math.max(this.drawArea.y,Math.min(this.drawArea.y+this.drawArea.height,g));if(this.ctx.moveTo(h[0].x,f),this.ctx.lineTo(h[0].x,h[0].y),c>0)for(let u=0;u<h.length-1;u++){let p=h[0===u?0:u-1],b=h[u],$=h[u+1],y=h[u+2<h.length?u+2:u+1],{cp1:m,cp2:v}=this._getControlPointsForSegment(p,b,$,y,.2*c);this.ctx.bezierCurveTo(m.x,m.y,v.x,v.y,$.x,$.y)}else for(let A=1;A<h.length;A++)this.ctx.lineTo(h[A].x,h[A].y);this.ctx.lineTo(h[h.length-1].x,f),this.ctx.closePath();let w=h.map(t=>t.y).concat([f]),C={x:this.drawArea.x,y:Math.min(...w),w:this.drawArea.width,h:Math.abs(Math.max(...w)-Math.min(...w))};if(x)this.ctx.fillStyle=this.activePalette.backgroundColor;else{let _=this.activePalette.defaultDatasetColors[e%this.activePalette.defaultDatasetColors.length],P=t.backgroundColor||_;this.ctx.fillStyle=this._resolveColor(P,C)}this.ctx.fill()}if(d>0&&h.length>0){if(this.ctx.beginPath(),this.ctx.moveTo(h[0].x,h[0].y),c>0&&h.length>1)for(let E=0;E<h.length-1;E++){let T=h[0===E?0:E-1],S=h[E],D=h[E+1],k=h[E+2<h.length?E+2:E+1],{cp1:L,cp2:R}=this._getControlPointsForSegment(T,S,D,k,.2*c);this.ctx.bezierCurveTo(L.x,L.y,R.x,R.y,D.x,D.y)}else if(h.length>1)for(let F=1;F<h.length;F++)this.ctx.lineTo(h[F].x,h[F].y);if(x)this.ctx.strokeStyle=x;else{let M=this.activePalette.defaultDatasetColors[e%this.activePalette.defaultDatasetColors.length],I=t.borderColor||M;this.ctx.strokeStyle=this._resolveColor(I,this.drawArea)}this.ctx.lineWidth=d;let B=!1;t.borderDash&&Array.isArray(t.borderDash)&&t.borderDash.length>0&&(this.ctx.setLineDash(t.borderDash),B=!0),this.ctx.stroke(),B&&this.ctx.setLineDash([])}let H=void 0!==t.pointRadius?t.pointRadius:void 0!==a.pointRadius?a.pointRadius:3,W=void 0!==t.pointBorderWidth?t.pointBorderWidth:1;H>0&&h.length>0&&h.forEach(i=>{let s={x:i.x-H,y:i.y-H,w:2*H,h:2*H};if(x)this.ctx.fillStyle=this.activePalette.backgroundColor,this.ctx.strokeStyle=x,this.ctx.lineWidth=W>0?W:1;else{let l=t.pointColor;void 0===l&&(l=t.fill&&t.backgroundColor?t.borderColor||this.activePalette.defaultDatasetColors[e%this.activePalette.defaultDatasetColors.length]:t.backgroundColor||t.borderColor||this.activePalette.defaultDatasetColors[e%this.activePalette.defaultDatasetColors.length]),this.ctx.fillStyle=this._resolveColor(l,s),t.pointBorderColor&&W>0?(this.ctx.strokeStyle=this._resolveColor(t.pointBorderColor,s),this.ctx.lineWidth=W):this.ctx.strokeStyle="transparent"}this.ctx.beginPath();let r=t.pointStyle||a.pointStyle||"circle";"square"===r?this.ctx.rect(s.x,s.y,s.w,s.h):this.ctx.arc(i.x,i.y,H,0,2*Math.PI),this.ctx.fill(),"transparent"!==this.ctx.strokeStyle&&W>0&&this.ctx.stroke()}),this.ctx.restore()})}_getPointPosition(t,e,i,s,a){if(0===s||0===this.drawArea.width)return{x:this.drawArea.x+this.drawArea.width/2,y:this.drawArea.y+this.drawArea.height/2};let l;if("bar"===a){let r=this.drawArea.width/s;l=this.drawArea.x+e*r+r/2}else if(1===s)l=this.drawArea.x+this.drawArea.width/2;else{let o=this.drawArea.width/(s-1);l=this.drawArea.x+e*o}let n=parseFloat(t);if(isNaN(n))return{x:l,y:this.drawArea.y+this.drawArea.height/2};let h=i.min||0,c=i.scale||1,d=this.drawArea.y+this.drawArea.height-(n-h)*c;return isFinite(d)||(d=this.drawArea.y+this.drawArea.height/2),d=Math.max(this.drawArea.y,Math.min(d,this.drawArea.y+this.drawArea.height)),{x:l,y:d}}_findXCoordinateForDate(t){let e=this.config.data.labels,i=this.drawArea;if(!e||0===e.length||!i||void 0===i.width)return null;let s=new Date(t).getTime();if(isNaN(s))return null;let a=-1,l=1/0;for(let r=0;r<e.length;r++){let o=new Date(e[r]).getTime();if(isNaN(o))continue;let n=Math.abs(o-s);n<l&&(l=n,a=r)}if(-1===a)return null;let h=e.length,c=h>1?i.width/(h-1):i.width/2,d=i.x+a*c;return d}_getMousePos(t){let e=this.canvas.getBoundingClientRect();return{x:t.clientX-e.left,y:t.clientY-e.top}}_onMouseMove(t){if(!this.tooltipElement||!this.config.options.tooltip.enabled||!this.interactiveElements)return;let e=this._getMousePos(t),i=this.canvas.getBoundingClientRect(),s=null,a=1/0;for(let l=this.interactiveElements.length-1;l>=0;l--){let r=this.interactiveElements[l],o=!1;if("point"===r.type&&r.pos){let n=void 0!==r.radius?r.radius:void 0!==this.config.options.line.pointRadius?this.config.options.line.pointRadius:3,h=n+3,c=e.x-r.pos.x,d=e.y-r.pos.y,x=c*c+d*d;x<=h*h&&(x<a&&(a=x,s=r),o=!0)}else if(("bar"===r.type||"percentageDistribution"===r.type)&&r.rect&&e.x>=r.rect.x&&e.x<=r.rect.x+r.rect.w&&e.y>=r.rect.y&&e.y<=r.rect.y+r.rect.h){s=r;break}}if(s){let g,f,u;if("percentageDistribution"===s.type)f=s.rect.x+s.rect.w/2+i.left,u=s.rect.y+s.rect.h/2+i.top,g={type:"percentageDistribution",item:s.item,themePalette:this.activePalette};else if("bar"===s.type||"point"===s.type){let p=s.pointIndex,b=this._currentDrawingData||this.config.data,$=b.labels&&b.labels.length>p?String(b.labels[p]):s.xLabel||`Index ${p}`,y=[];(b.datasets||[]).forEach(t=>{if(t._hidden)return;let e=t.type||this.config.type;if("percentageDistribution"===e)return;let i=t.values&&t.values.length>p&&null!==t.values[p]&&void 0!==t.values[p]?t.values[p]:void 0,s=t.borderColor||t.backgroundColor;Array.isArray(s)&&(s=s[0]);let a="number"==typeof t.originalIndex?t.originalIndex:0;if(!s){let l=this.activePalette||PC_LIGHT_THEME_PALETTE;s=l.defaultDatasetColors[a%l.defaultDatasetColors.length]}y.push({dataset:{label:t.label||`Dataset ${a+1}`,color:s,originalIndex:a},value:i})}),y.length>0&&("point"===s.type&&s.pos?(f=s.pos.x+i.left,u=s.pos.y+i.top):"bar"===s.type&&s.rect?(f=s.rect.x+s.rect.w/2+i.left,u=s.rect.y+i.top):(f=e.x+i.left,u=e.y+i.top),g={type:"shared",xLabel:$,datasets:y,themePalette:this.activePalette})}if(g){g.anchorX=f,g.anchorY=u;let m=JSON.stringify(g);this.activeTooltipData&&this.activeTooltipData.signature===m?this._positionTooltip(f,u):(this.activeTooltipData={signature:m,data:g},this._showTooltip(g)),this.canvas.style.cursor="pointer"}else this._onMouseOut()}else this._onMouseOut()}_showTooltip(t){this.tooltipElement&&this.config.options.tooltip.enabled&&(this.tooltipElement.innerHTML=this.config.options.tooltip.formatter(t),this.tooltipElement.style.visibility="visible",this._positionTooltip(t.anchorX,t.anchorY))}_positionTooltip(t,e){if(!this.tooltipElement||"hidden"===this.tooltipElement.style.visibility)return;this.tooltipElement.style.backgroundColor=this.activePalette.tooltipBgColor,this.tooltipElement.style.color=this.activePalette.tooltipColor;let i=this.tooltipElement.getBoundingClientRect(),s=i.width,a=i.height,l=this.config.options.tooltip.offset||10,r=window.scrollX||window.pageXOffset,o=window.scrollY||window.pageYOffset,n=window.innerWidth,h=window.innerHeight,c=t+r-s/2,d=e+o-a-l;if(d-o<5&&(d=e+o+l),d-o+a>h-5){let x=e+o-a-l;x-o>=5?d=x:(d=o+h-a-5)-o<5&&(d=o+5)}c-r<5&&(c=r+5),c-r+s>n-5&&(c=r+n-s-5),c-r<5&&(c=r+5),this.tooltipElement.style.left=`${c}px`,this.tooltipElement.style.top=`${d}px`}_onMouseOut(){this.tooltipElement&&this.config.options.tooltip.enabled&&(this.tooltipElement.style.visibility="hidden"),this.activeTooltipData=null,this.canvas&&(this.canvas.style.cursor="default")}_drawAnnotations(){let t=this.config.options.annotations;if(!t||!Array.isArray(t)||0===t.length||!this.config.options.yAxes||0===this.config.options.yAxes.length||!this.yAxisScales||0===Object.keys(this.yAxisScales).length)return;let e=this.config.options.yAxes[0].id;this.ctx.save(),t.forEach(t=>{if("line"!==t.type||"horizontal"!==t.mode)return;let i=t.yAxisID||e,s=this.yAxisScales[i];if(!s||!s.scale||s.scale<=0||!isFinite(s.scale)||!s.axisConfig||!s.axisConfig.display)return;let{min:a,max:l,scale:r}=s,o=null;if(void 0!==t.value)o=this.drawArea.y+this.drawArea.height-(t.value-a)*r;else if(void 0!==t.percentage&&"number"==typeof t.percentage){let n=l-a,h;h=0===n?a:a+t.percentage/100*n,o=this.drawArea.y+this.drawArea.height-(h-a)*r}if(null===o||isNaN(o)||!isFinite(o)){console.warn(`PureChart Annotation: Could not determine Y position for annotation on Y-axis ID '${i}'.`,t);return}o=Math.max(this.drawArea.y,Math.min(o,this.drawArea.y+this.drawArea.height)),this.ctx.save(),this.ctx.beginPath(),this.ctx.moveTo(this.drawArea.x,o),this.ctx.lineTo(this.drawArea.x+this.drawArea.width,o),this.ctx.strokeStyle=t.borderColor||this.activePalette.gridColor,this.ctx.lineWidth=t.borderWidth||1;let c=!1;if(t.borderDash&&Array.isArray(t.borderDash)&&t.borderDash.length>0&&(this.ctx.setLineDash(t.borderDash),c=!0),this.ctx.stroke(),c&&this.ctx.setLineDash([]),this.ctx.restore(),t.label&&t.label.text){this.ctx.save();let d=t.label,x=this.config.options.font||"10px Arial";this.ctx.font=d.font||x;let g=d.color||s.axisConfig.color||this.activePalette.axisColor;this.ctx.fillStyle=g;let f,u,p="right",b="bottom",$=void 0===d.padding?2:d.padding,y={x:"object"==typeof $?$.x||0:$,y:"object"==typeof $?$.y||0:$},m=d.position||"right";switch(m){case"left":case"top-left":p="left",b="bottom",f=this.drawArea.x+y.x,u=o-y.y;break;case"bottom-left":p="left",b="top",f=this.drawArea.x+y.x,u=o+y.y;break;case"top-right":default:p="right",b="bottom",f=this.drawArea.x+this.drawArea.width-y.x,u=o-y.y;break;case"bottom-right":p="right",b="top",f=this.drawArea.x+this.drawArea.width-y.x,u=o+y.y;break;case"center":p="center",b="bottom",f=this.drawArea.x+this.drawArea.width/2,u=o-y.y}if(this.ctx.textAlign=p,this.ctx.textBaseline=b,d.backgroundColor){let v=this.ctx.measureText(d.text),A=parseInt(this.ctx.font.match(/(\d+)px/)?.[1]||"10"),w=v.width+2*y.x,C=A+2*y.y,_=f;_="right"===p?f-v.width-y.x:"center"===p?f-v.width/2-y.x:f-y.x;let P=u;P="bottom"===b?u-A-y.y:"middle"===b?u-A/2-y.y:u-y.y,this.ctx.fillStyle=d.backgroundColor,this.ctx.fillRect(_,P,w,C),this.ctx.fillStyle=g}this.ctx.fillText(d.text,f,u),this.ctx.restore()}}),this.ctx.restore()}_drawPeriodHighlights(){if(!this.showPeriodHighlights)return;let t=this.config.options.periodHighlights;if(!t||!t.periods||0===t.periods.length)return;let e=this.drawArea;e&&t.periods.forEach(i=>{let s=this._findXCoordinateForDate(i.startDate),a=this._findXCoordinateForDate(i.endDate);if(null===s||null===a||s>=a)return;let l=t.defaultStyle||{},r=i.style||{},o={...l,...r,label:{...l.label||{},...r.label||{}}};if(o.fillColor&&(this.ctx.fillStyle=o.fillColor,this.ctx.fillRect(s,e.y,a-s,e.height)),o.borderWidth>0&&o.borderColor&&(this.ctx.strokeStyle=o.borderColor,this.ctx.lineWidth=o.borderWidth,this.ctx.strokeRect(s,e.y,a-s,e.height)),i.name&&o.label){this.ctx.save(),this.ctx.font=o.label.font||"10px Arial",this.ctx.fillStyle=o.label.color||"#000000",this.ctx.textAlign=o.label.textAlign||"center",this.ctx.textBaseline="middle";let n,h,c=s+(a-s)/2,d=e.y+e.height/2,x=o.label.offset||5;switch(o.label.position){case"center":n=c,h=d;break;case"below":n=c,h=e.y+e.height+x+this.ctx.measureText("M").width/2,o.label.angle&&o.label.angle%360!=0&&(h+=Math.abs(Math.sin(o.label.angle*Math.PI/180)*(this.ctx.measureText(i.name).width/2)));break;default:n=c,h=e.y-x-this.ctx.measureText("M").width/2,o.label.angle&&o.label.angle%360!=0&&(h-=Math.abs(Math.sin(o.label.angle*Math.PI/180)*(this.ctx.measureText(i.name).width/2)))}this.ctx.translate(n,h),this.ctx.rotate((o.label.angle||0)*Math.PI/180),this.ctx.fillText(i.name,0,0),this.ctx.restore()}})}_preprocessDatasetValues(){if(!this.config.data||!this.config.data.datasets||"pill"===this.config.type&&(!this.config.data.datasets||0===this.config.data.datasets.length))return;let t=this.config.data.datasets,e=this.config.data.labels?this.config.data.labels.length:0;t.forEach((i,s)=>{if("sma"===i.type){let a=!0,l=null;"number"!=typeof i.sourceDatasetIndex||i.sourceDatasetIndex<0||i.sourceDatasetIndex>=t.length?(console.warn(`PureChart SMA Error: Dataset ${s} ('${i.label}') has invalid sourceDatasetIndex ${i.sourceDatasetIndex}.`),a=!1):("sma"===(l=t[i.sourceDatasetIndex]).type&&(console.warn(`PureChart SMA Error: Dataset ${s} ('${i.label}') sourceDatasetIndex ${i.sourceDatasetIndex} ('${l.label}') is another SMA. Chaining SMAs is not supported.`),a=!1,l=null),i.sourceDatasetIndex===s&&(console.warn(`PureChart SMA Error: Dataset ${s} ('${i.label}') sourceDatasetIndex cannot be itself.`),a=!1,l=null)),("number"!=typeof i.period||i.period<=0)&&(console.warn(`PureChart SMA Error: Dataset ${s} ('${i.label}') has invalid period ${i.period}.`),a=!1),a&&l?l._hidden?i.values=e>0?Array(e).fill(null):[]:l.values&&0!==l.values.length?(i.values=PureChart._calculateSMA(l.values,i.period),0===i.values.length&&l.values.length>0&&console.warn(`PureChart SMA Warning: Dataset ${s} ('${i.label}') period ${i.period} is greater than source data length ${l.values.length}. Resulting in empty SMA.`)):(console.warn(`PureChart SMA Error: Source dataset ${i.sourceDatasetIndex} ('${l.label}') for SMA dataset ${s} ('${i.label}') has no values.`),i.values=e>0?Array(e).fill(null):[]):i.values=e>0?Array(e).fill(null):[]}})}destroy(){this.isValid&&(this.canvas&&(this.config&&this.config.options&&this.config.options.tooltip&&this.config.options.tooltip.enabled&&(this._boundOnMouseMove&&this.canvas.removeEventListener("mousemove",this._boundOnMouseMove),this._boundOnMouseOut&&(this.canvas.removeEventListener("mouseout",this._boundOnMouseOut),this.canvas.removeEventListener("mouseleave",this._boundOnMouseOut))),this._boundOnCanvasClick&&this.canvas.removeEventListener("click",this._boundOnCanvasClick)),this.tooltipElement&&(this.tooltipElement.parentElement&&this.tooltipElement.remove(),this.tooltipElement=null),this.resizeObserver&&(this.resizeObserver.disconnect(),this.resizeObserver=null),this.debouncedResize&&(this.debouncedResize=null),this.ctx=null,this.canvas=null,this.config&&(this.config=null),this.interactiveElements=[],this.interactiveLegendItems=[],this.activeTooltipData=null,this.yAxisScales=null,this.drawArea=null,this._boundOnMouseMove=null,this._boundOnMouseOut=null,this._boundOnCanvasClick=null,this.isValid=!1)}_drawPillChart(){let t=this.config.options.pill,e=this.drawArea;if(!e||e.width<=0||t.pillHeight<=0){console.warn("PureChart (Pill): Invalid drawing area or pill dimensions."),this.ctx.font="12px Arial",this.ctx.fillStyle="orange",this.ctx.textAlign="center",this.ctx.fillText("Pill Chart: Invalid dimensions.",this.canvas.width/2,this.canvas.height/2);return}if(t.max<=t.min){this.ctx.font="12px Arial",this.ctx.fillStyle="red",this.ctx.textAlign="center",this.ctx.fillText("Error: Max must be greater than Min for Pill Chart.",e.x+e.width/2,e.y+e.height/2);return}let i=e.width/(t.max-t.min),s=s=>{let a=Math.max(t.min,Math.min(t.max,s));return e.x+(a-t.min)*i},a=e.y+e.height/2-t.pillHeight/2,l=t.zoneOverflowAmount||0,r=t.pillBorderWidth,o=t.fillLightenPercent,n=t.colors.mainBackground,h=this._lightenColor(n,o);this.ctx.fillStyle=h,this._fillRoundRect(this.ctx,e.x,a,e.width,t.pillHeight,t.borderRadius),r>0&&(this.ctx.strokeStyle=n,this.ctx.lineWidth=r,this._strokeRoundRect(this.ctx,e.x,a,e.width,t.pillHeight,t.borderRadius,r));let c=t.zoneMin,d=t.zoneMax,x=Math.max(t.min,Math.min(t.max,c)),g=Math.max(t.min,Math.min(t.max,d));if(g>x){let f=s(x),u=s(g),p=u-f;if(p>0){let b=t.colors.zoneBackground,$=this._lightenColor(b,o);this.ctx.save(),this.ctx.beginPath(),this.ctx.moveTo(e.x+t.borderRadius,a),this.ctx.lineTo(e.x+e.width-t.borderRadius,a),t.borderRadius>0&&this.ctx.arcTo(e.x+e.width,a,e.x+e.width,a+t.borderRadius,t.borderRadius),this.ctx.lineTo(e.x+e.width,a+t.pillHeight-t.borderRadius),t.borderRadius>0&&this.ctx.arcTo(e.x+e.width,a+t.pillHeight,e.x+e.width-t.borderRadius,a+t.pillHeight,t.borderRadius),this.ctx.lineTo(e.x+t.borderRadius,a+t.pillHeight),t.borderRadius>0&&this.ctx.arcTo(e.x,a+t.pillHeight,e.x,a+t.pillHeight-t.borderRadius,t.borderRadius),this.ctx.lineTo(e.x,a+t.borderRadius),t.borderRadius>0&&this.ctx.arcTo(e.x,a,e.x+t.borderRadius,a,t.borderRadius),this.ctx.closePath(),this.ctx.clip();let y=a-l,m=t.pillHeight+2*l;this.ctx.fillStyle=$,this.ctx.fillRect(f,y,p,m),r>0&&(this.ctx.strokeStyle=b,this.ctx.lineWidth=r,this.ctx.strokeRect(f,y,p,m)),this.ctx.restore()}}let v=s(t.value);if(this.ctx.strokeStyle=t.colors.cursor,this.ctx.lineWidth=t.cursorThickness,this.ctx.lineCap="round",this.ctx.beginPath(),this.ctx.moveTo(v,a-t.cursorLengthExtension),this.ctx.lineTo(v,a+t.pillHeight+t.cursorLengthExtension),this.ctx.stroke(),t.showMinMaxLabels){this.ctx.font=t.mainLabelFont||t.labelFont,this.ctx.fillStyle=t.colors.minMaxText;let A=t.minMaxLabelPosition,w=a+t.pillHeight/2,C,_,P,E,T,S,D=t.zoneLabelOffset||5;switch(A){case"aboveEnds":P=a-D,S="bottom",E="left",T="right",C=e.x+(t.borderRadius/2||0)+2,_=e.x+e.width-(t.borderRadius/2||0)-2;break;case"belowEnds":P=a+t.pillHeight+D,S="top",E="left",T="right",C=e.x+(t.borderRadius/2||0)+2,_=e.x+e.width-(t.borderRadius/2||0)-2;break;default:P=w,S="middle",E="left",T="right",C=Math.max(e.x+2,e.x+t.borderRadius/2+2),_=Math.min(e.x+e.width-2,e.x+e.width-t.borderRadius/2-2)}this.ctx.textAlign=E,this.ctx.textBaseline=S,this.ctx.fillText(String(t.min),C,P),this.ctx.textAlign=T,this.ctx.fillText(String(t.max),_,P)}if(t.showValueLabel){this.ctx.font=t.mainLabelFont||t.labelFont,this.ctx.fillStyle=t.colors.valueText,this.ctx.textAlign="center";let k,L=String(t.value);switch(t.valueLabelPosition){case"above":k=a-t.cursorLengthExtension-5,this.ctx.textBaseline="bottom";break;case"inside":k=a+t.pillHeight/2,this.ctx.textBaseline="middle";break;default:k=a+t.pillHeight+t.cursorLengthExtension+10,this.ctx.textBaseline="top"}this.ctx.fillText(L,v,k)}if(t.showZoneMinMaxLabels){let R=s(t.zoneMin),F=s(t.zoneMax),M=[{value:t.zoneMin,x:R,defaultAlign:"left"},{value:t.zoneMax,x:F,defaultAlign:"right"}];M.forEach(e=>{let i=String(e.value);this.ctx.font=t.zoneLabelFont;let s=t.zoneLabelColor;"#333333"===s&&"dark"===this.activePalette.name?s=this.activePalette.labelColor:s||(s=this.activePalette.labelColor||"#333333"),this.ctx.fillStyle=s;let l=e.x,r,o,n=t.zoneOverflowAmount||0,h=t.zoneLabelOffset;switch(t.zoneLabelPosition){case"below":r=a+t.pillHeight+n+h,this.ctx.textBaseline="top",o="center";break;case"on":r=a+t.pillHeight/2,this.ctx.textBaseline="middle",e.x===R?(o="left",l=R+h):(o="right",l=F-h);break;default:r=a-n-h,this.ctx.textBaseline="bottom",o="center"}this.ctx.textAlign=o;let c=this.ctx.measureText(i),d=this.ctx.font.match(/(\d+)px/),x=d?parseInt(d[1],10):10,g=t.zoneLabelBackgroundPadding,f=c.width+2*g,u=x+2*g,p,b;p="center"===o?l-f/2:"left"===o?l-g:l-c.width-g,b="top"===this.ctx.textBaseline?r-g:"bottom"===this.ctx.textBaseline?r-x-g:r-u/2;let $=t.zoneLabelBackgroundColor;$&&"transparent"!==$&&(this.ctx.fillStyle=$,this.ctx.fillRect(p,b,f,u)),this.ctx.fillStyle=s,this.ctx.fillText(i,l,r)})}}}