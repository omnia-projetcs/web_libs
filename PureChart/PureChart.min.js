const PC_LIGHT_THEME_PALETTE={name:"light",backgroundColor:"#FFFFFF",axisColor:"#666666",gridColor:"#E0E0E0",labelColor:"#333333",titleColor:"#333333",legendColor:"#333333",tooltipBgColor:"rgba(0,0,0,0.85)",tooltipColor:"#FFFFFF",defaultDatasetColors:["#007bff","#28a745","#dc3545","#ffc107","#17a2b8","#6f42c1","#e83e8c","#fd7e14","#20c997","#6610f2"],bar:{borderColorDarkenPercent:20},line:{},annotations:{}},PC_DARK_THEME_PALETTE={name:"dark",backgroundColor:"#22272E",axisColor:"#ADBAC7",gridColor:"#444C56",labelColor:"#F0F6FC",titleColor:"#F0F6FC",legendColor:"#F0F6FC",tooltipBgColor:"rgba(20,20,25,0.85)",tooltipColor:"#F0F6FC",defaultDatasetColors:["#58A6FF","#52D57B","#F87171","#FDB863","#6CBBEB","#B197FC","#F781BE","#FFA94D","#48D2A0","#A371F7"],bar:{borderColorDarkenPercent:0,borderColorLightenPercent:20},line:{},annotations:{}};class PureChart{constructor(t,e){const i=document.getElementById(t);if(!i||"CANVAS"!==i.tagName)return console.error(`PureChart Error: Element with id "${t}" not found or is not a canvas.`),void(this.isValid=!1);this.isValid=!0,this.canvas=i,this.ctx=this.canvas.getContext("2d"),this.initialCanvasWidth=this.canvas.getAttribute("width")?parseInt(this.canvas.getAttribute("width"),10):0,this.initialCanvasHeight=this.canvas.getAttribute("height")?parseInt(this.canvas.getAttribute("height"),10):0,this.interactiveElements=[],this.interactiveLegendItems=[],this.activeTooltipData=null,this.resizeObserver=null,this.debouncedResize=null;const s={width:this.initialCanvasWidth||300,height:this.initialCanvasHeight||150,type:"bar",theme:"light",data:{},options:{autosize:!0,contourColor:null,padding:{top:20,right:20,bottom:40,left:20},yAxes:[{id:"left",position:"left",display:!1,beginAtZero:!0,title:"",displayTitle:!0,maxTicks:5,gridLines:!0,labelFont:"10px Arial",titleFont:"12px Arial bold",color:"#666",sampleLabelForWidthEstimation:"-9,999.9"}],xAxis:{display:!1,title:"",displayTitle:!0,gridLines:!1,labelFont:"10px Arial",titleFont:"12px Arial bold",color:"#666"},title:{display:!0,text:"",font:"18px Arial bold",color:"#333",padding:15},legend:{display:!0,position:"top",font:"12px Arial",color:"#333",padding:10,markerSize:12,markerStyle:"square"},bar:{itemSpacingFactor:.1,groupSpacingFactor:.2,defaultBorderWidth:1,borderDarkenPercent:20,topCornerRadius:0,averageLine:{display:!1,color:"#888",lineWidth:1,dashPattern:[3,3],label:{display:!0,font:"10px Arial",color:"#555",position:"above-right",padding:2,backgroundColor:"rgba(255, 255, 255, 0.7)",formatter:t=>{if(null==t)return"Avg: N/A";let e=t.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2});return e=e.replace(/,/g," "),`Avg: ${e}`}}}},line:{pointRadius:3,lineWidth:2,tension:0,pointStyle:"circle",averageLine:{display:!1,color:"#888",lineWidth:1,dashPattern:[3,3],label:{display:!0,font:"10px Arial",color:"#555",position:"above-right",padding:2,backgroundColor:"rgba(255, 255, 255, 0.7)",formatter:t=>{if(null==t)return"Avg: N/A";let e=t.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2});return e=e.replace(/,/g," "),`Avg: ${e}`}}}},percentageDistribution:{barHeight:20,barSpacing:3,barBorderRadius:4,labelFont:"12px Arial",labelColor:"#333",valueFont:"12px Arial bold",valueColor:"#333",showValueText:!0,labelPosition:"left",valuePosition:"right",colors:null,maxLabelWidth:100,valueTextMargin:8,sort:"none",borderWidth:1,borderColor:void 0,borderDarkenPercent:20,fillLightenPercent:void 0,valuesArePercentages:!1},pill:{min:0,max:100,zoneMin:20,zoneMax:80,value:50,borderRadius:10,pillHeight:30,colors:{mainBackground:"#e0e0e0",zoneBackground:"#a0a0a0",cursor:"#ff0000",text:"#000000",minMaxText:"#333333",valueText:"#111111"},cursorThickness:2,cursorLengthExtension:5,showMinMaxLabels:!0,showValueLabel:!0,valueLabelPosition:"below",labelFont:"10px Arial",mainLabelFont:"11px Arial",minMaxLabelPosition:"ends",pillBorderWidth:1,fillLightenPercent:70,zoneOverflowAmount:5,showZoneMinMaxLabels:!1,zoneLabelFont:"10px Arial",zoneLabelColor:"#333333",zoneLabelOffset:5,zoneLabelBackgroundPadding:2,zoneLabelBackgroundColor:"rgba(255, 255, 255, 0.7)",zoneLabelPosition:"above"},gridColor:"#e0e0e0",tooltip:{enabled:!0,backgroundColor:"rgba(0,0,0,0.85)",color:"white",font:"12px Arial",padding:"10px",borderRadius:"5px",offset:10,formatter:t=>{if(!t)return"";if("percentageDistribution"===t.type&&t.item){let e=t.item.value.toLocaleString("en-US").replace(/,/g," ");return`<div style="text-align:left;"><strong>${t.item.label}</strong><br/>Value: ${e}<br/>Percentage: ${t.item.percentage.toFixed(1)}%</div>`}let e=`<div style="font-weight:bold;margin-bottom:5px;text-align:left;">${t.xLabel||""}</div>`;return(t.datasets||[]).forEach((i=>{if(i&&i.dataset){let s=i.dataset.color;if(s||(s=i.dataset.borderColor||(Array.isArray(i.dataset.backgroundColor)?i.dataset.backgroundColor[0]:i.dataset.backgroundColor)),!s&&t.themePalette){const e=void 0!==i.dataset.originalIndex?i.dataset.originalIndex:0;s=t.themePalette.defaultDatasetColors[e%t.themePalette.defaultDatasetColors.length]}s=s||"#ccc";let a=void 0!==i.value&&null!==i.value?i.value.toLocaleString("en-US").replace(/,/g," "):"N/A";e+=`<div style="text-align:left;"><span style="display:inline-block;width:10px;height:10px;border-radius:50%;background-color:${s};margin-right:5px;"></span>${i.dataset.label||"Dataset"}: ${a}</div>`}})),e}},periodHighlights:{display:!1,legendLabel:"Periods",periods:[],defaultStyle:{fillColor:"rgba(255, 0, 0, 0.1)",borderColor:"rgba(255, 0, 0, 0.3)",borderWidth:1,label:{font:"10px Arial",color:"#000000",angle:-30,position:"above",offset:5,textAlign:"center"}}}}};if(this.config=PureChart._mergeDeep(s,e),this.showPeriodHighlights=this.config.options.periodHighlights&&this.config.options.periodHighlights.display,this.config.options.autosize){const t=this.canvas.parentElement;t?(this.debouncedResize=PureChart._debounce(this._handleResize.bind(this),250),this.resizeObserver=new ResizeObserver((t=>{for(let e of t)this.debouncedResize(e.contentRect)})),this.resizeObserver.observe(t),this._handleResize(t.getBoundingClientRect())):(console.error("PureChart Autosize Error: Canvas parent element not found. Autosize disabled for this instance."),this.config.options.autosize=!1)}const a=s.options.yAxes[0];if(!this.config.options.yAxis||e.options?.yAxes&&void 0!==e.options.yAxes)this.config.options.yAxes&&Array.isArray(this.config.options.yAxes)?this.config.options.yAxes=this.config.options.yAxes.map((t=>{let e=PureChart._mergeDeep({},a);return PureChart._mergeDeep(e,t)})):this.config.options.yAxes=[PureChart._mergeDeep({},a)];else{const t=this.config.options.yAxis;let e=PureChart._mergeDeep({},a);this.config.options.yAxes=[PureChart._mergeDeep(e,t)],delete this.config.options.yAxis}if(this.config.options.yAxes&&Array.isArray(this.config.options.yAxes)&&this.config.options.yAxes.forEach(((t,e)=>{t.id||(t.id=0===e?"left":`yAxis-${e}`),t.position||(t.position=0===e?"left":1===e?"right":"left")})),"object"==typeof this.config.theme&&null!==this.config.theme){let t;t="dark"===this.config.theme.extends?PC_DARK_THEME_PALETTE:PC_LIGHT_THEME_PALETTE,this.activePalette=PureChart._mergeDeep({},t),this.activePalette=PureChart._mergeDeep(this.activePalette,this.config.theme);for(const e in t)void 0===this.activePalette[e]&&t.hasOwnProperty(e)&&"object"!=typeof t[e]?this.activePalette[e]=t[e]:"object"!=typeof t[e]||null===t[e]||Array.isArray(t[e])||(this.activePalette[e]||(this.activePalette[e]={}),this.activePalette[e]=PureChart._mergeDeep({},t[e],this.activePalette[e]));this.activePalette.name||(this.activePalette.name=t.name)}else"dark"===this.config.theme?this.activePalette={...PC_DARK_THEME_PALETTE}:this.activePalette={...PC_LIGHT_THEME_PALETTE};if(this.config.data&&this.config.data.datasets&&this.config.options.yAxes&&this.config.options.yAxes.length>0){const t=this.config.options.yAxes[0].id;this.config.data.datasets.forEach((e=>{void 0===e.yAxisID&&(e.yAxisID=t)}))}this._validateConfig(),this.isValid&&(this.canvas.width=this.config.width,this.canvas.height=this.config.height,this.isValid&&this.config.options.tooltip.enabled&&(this._createTooltipElement(),this._boundOnMouseMove=this._onMouseMove.bind(this),this._boundOnMouseOut=this._onMouseOut.bind(this),this.canvas.addEventListener("mousemove",this._boundOnMouseMove),this.canvas.addEventListener("mouseout",this._boundOnMouseOut),this.canvas.addEventListener("mouseleave",this._boundOnMouseOut)),this.config.data&&this.config.data.datasets&&this.config.data.datasets.forEach((t=>{t._hidden=!1})),this._boundOnCanvasClick=this._onCanvasClick.bind(this),this.canvas.addEventListener("click",this._boundOnCanvasClick),this._draw())}static _debounce(t,e){let i;return function(...s){const a=this;clearTimeout(i),i=setTimeout((()=>t.apply(a,s)),e)}}_handleResize(t){if(!this.isValid)return;if(!t)return;let e=Math.floor(t.width),i=Math.floor(t.height);this.initialCanvasWidth>0&&(e=Math.min(e,this.initialCanvasWidth)),this.initialCanvasHeight>0&&(i=Math.min(i,this.initialCanvasHeight)),this.canvas.width===e&&this.canvas.height===i||(this.canvas.width=e,this.canvas.height=i,this.config.width=e,this.config.height=i,this._draw())}static _calculateSMA(t,e){if(!t||e<=0||0===t.length)return[];if(t.length<e)return new Array(t.length).fill(null);const i=[];for(let s=0;s<=t.length-e;s++){let a=0,o=0;for(let i=0;i<e;i++)"number"!=typeof t[s+i]||isNaN(t[s+i])||(a+=t[s+i],o++);i.push(o>0?a/o:null)}return new Array(e-1).fill(null).concat(i)}static _calculateDatasetAverage(t){if(!Array.isArray(t))return null;const e=t.filter((t=>"number"==typeof t&&!isNaN(t)));if(0===e.length)return null;return e.reduce(((t,e)=>t+e),0)/e.length}static _mergeDeep(t,e){const i=t=>t&&"object"==typeof t&&!Array.isArray(t);let s={...t};return i(t)&&i(e)&&Object.keys(e).forEach((a=>{i(e[a])?a in t&&i(t[a])?s[a]=PureChart._mergeDeep(t[a],e[a]):s[a]={...e[a]}:s[a]=e[a]})),s}static async fromJSON(t,e,i={},s=null){try{const a={};s&&(a.headers={"X-CSRFToken":s});const o=await fetch(e,a);if(!o.ok)throw console.error(`PureChart Fetch Error: Status ${o.status} for URL ${e}`),new Error(`PureChart Error: Failed to fetch JSON from ${e}. Status: ${o.status}`);const r=await o.json();let l=r;r&&"object"==typeof r.chart_datas&&null!==r.chart_datas&&(l=r.chart_datas);let n={};n=PureChart._mergeDeep(l,i);const h=document.getElementById(t);return h&&(!n.width&&h.width&&(n.width=h.width),!n.height&&h.height&&(n.height=h.height)),new PureChart(t,n)}catch(e){console.error("PureChart Error (fromJSON catch block):",e);const i=document.getElementById(t);if(i&&i.getContext){const t=i.getContext("2d");t.clearRect(0,0,i.width,i.height),t.font="12px Arial",t.fillStyle="red",t.textAlign="center";const s=`Error loading chart from JSON: ${String(e.message).substring(0,100)}`;String(s).split("\n").forEach(((e,a)=>{t.fillText(e,i.width/2,i.height/2-7*(String(s).split("\n").length-1)+14*a)}))}return null}}_validateConfig(){if("percentageDistribution"===this.config.type){if(!this.config.data||!Array.isArray(this.config.data.items)||0===this.config.data.items.length)return console.error("PureChart Error (percentageDistribution): data.items array is required and non-empty."),void(this.isValid=!1);if(this.isValid&&this.config.data.items.forEach(((t,e)=>{(null===t||"object"!=typeof t||"string"!=typeof t.label||"number"!=typeof t.value||t.value<0||isNaN(t.value))&&(console.error(`PureChart Error (percentageDistribution): Item ${e} is invalid. Must be {label: string, value: non-negative number}. Item:`,t),this.isValid=!1)})),!this.isValid)return;this.config.options.percentageDistribution&&this.config.options.percentageDistribution.valuesArePercentages&&this.config.data.items.forEach(((t,e)=>{"number"==typeof t.value&&!isNaN(t.value)&&(t.value<0||t.value>100)&&console.warn(`PureChart Warning (percentageDistribution): Item '${t.label||`Index ${e}`}' has value ${t.value} which is outside the expected 0-100 range when valuesArePercentages is true.`)})),this.config.options.xAxis.display=this.config.options.xAxis.display??!1,this.config.options.yAxes&&this.config.options.yAxes.length>0&&(this.config.options.yAxes[0].display=this.config.options.yAxes[0].display??!1),this.config.options.legend.display=this.config.options.legend.display??!1}else if("pill"===this.config.type){if(!this.config.data)return console.error("PureChart Error (pill): data object is required."),void(this.isValid=!1);this.config.options.xAxis.display=this.config.options.xAxis.display??!1,this.config.options.yAxes&&this.config.options.yAxes.length>0&&(this.config.options.yAxes[0].display=this.config.options.yAxes[0].display??!1),this.config.options.legend.display=this.config.options.legend.display??!1}else{if(!this.config.data||!this.config.data.labels||!this.config.data.datasets)return console.error("PureChart Error (bar/line/other): data.labels and data.datasets are required."),void(this.isValid=!1);if(this.isValid&&this.config.data.datasets.forEach(((t,e)=>{const i=t.type||this.config.type;"sma"!==i&&(t.values&&Array.isArray(t.values)||(console.error(`PureChart Error (bar/line/other): Dataset ${e} ('${t.label||"Untitled"}') missing 'values' array.`),this.isValid=!1)),"line"!==i&&"sma"!==i||void 0!==t.fill||(t.fill=!1)})),!this.isValid)return}}_resolveColor(t,e){if("function"==typeof t)return t(this.ctx,e);if(Array.isArray(t)&&t.length>=2){const i=this.ctx.createLinearGradient(e.x,e.y,e.x,e.y+e.h);return i.addColorStop(0,t[0]),i.addColorStop(1,t[1]),i}return t||"#007bff"}_darkenColor(t,e){if("string"!=typeof t)return"#333333";let i,s,a,o=1;const r=1-e/100;if(t.startsWith("rgba")){const e=t.match(/[\d.]+/g);if(!(e&&e.length>=3))return"#333333";i=parseInt(e[0]),s=parseInt(e[1]),a=parseInt(e[2]),o=e.length>=4?parseFloat(e[3]):1}else if(t.startsWith("rgb")){const e=t.match(/\d+/g);if(!(e&&e.length>=3))return"#333333";i=parseInt(e[0]),s=parseInt(e[1]),a=parseInt(e[2])}else{if(!t.startsWith("#"))return"#333333";{let e=t.slice(1);if(3===e.length&&(e=e.split("").map((t=>t+t)).join("")),6!==e.length)return"#333333";{const t=parseInt(e,16);i=t>>16&255,s=t>>8&255,a=255&t}}}return i=Math.max(0,Math.floor(i*r)),s=Math.max(0,Math.floor(s*r)),a=Math.max(0,Math.floor(a*r)),`rgba(${i},${s},${a},${o})`}_lightenColor(t,e){if("string"!=typeof t)return"#EEEEEE";let i,s,a,o=1;const r=e/100;if(t.startsWith("rgba")){const e=t.match(/[\d.]+/g);if(!(e&&e.length>=3))return"#EEEEEE";i=parseInt(e[0]),s=parseInt(e[1]),a=parseInt(e[2]),o=e.length>=4?parseFloat(e[3]):1}else if(t.startsWith("rgb")){const e=t.match(/\d+/g);if(!(e&&e.length>=3))return"#EEEEEE";i=parseInt(e[0]),s=parseInt(e[1]),a=parseInt(e[2])}else{if(!t.startsWith("#")){try{const i=this.canvas.getContext("2d");i.fillStyle=t;const s=i.fillStyle;if(s.startsWith("#")||s.startsWith("rgb"))return this._lightenColor(s,e)}catch(t){}return"#EEEEEE"}{let e=t.slice(1);if(3===e.length&&(e=e.split("").map((t=>t+t)).join("")),6!==e.length)return"#EEEEEE";{const t=parseInt(e,16);i=t>>16&255,s=t>>8&255,a=255&t}}}return i=Math.min(255,Math.floor(i+(255-i)*r)),s=Math.min(255,Math.floor(s+(255-s)*r)),a=Math.min(255,Math.floor(a+(255-a)*r)),`rgba(${i},${s},${a},${o})`}_getAutoColor(t,e){const i=this.config.options.percentageDistribution.colors;if(i&&i[t%i.length])return i[t%i.length];return`hsl(${Math.round(t*(360/(e>1?e:2))%360)}, 70%, 55%)`}_getDrawingArea(){let{top:t,right:e,bottom:i,left:s}={...this.config.options.padding};const a=this.config.options;let o=t,r=e,l=i,n=s;if(a.title.display&&a.title.text&&(this.ctx.font=a.title.font,o+=1.5*this.ctx.measureText("M").width+a.title.padding),a.legend.display&&"percentageDistribution"!==this.config.type&&"pill"!==this.config.type){this.ctx.font=a.legend.font;const t=2.1*(1.5*this.ctx.measureText("M").width+a.legend.padding);"top"===a.legend.position?o+=t:l+=t}if("percentageDistribution"!==this.config.type&&"pill"!==this.config.type){let t=0,e=0;if(a.yAxes&&Array.isArray(a.yAxes)&&a.yAxes.forEach((i=>{if(i.display){let s=0;if(this.ctx.font=i.labelFont,s+=this.ctx.measureText(i.sampleLabelForWidthEstimation||"-9,999.9").width+10,i.displayTitle&&i.title){const t=this.ctx.font;this.ctx.font=i.titleFont,s+=1.5*this.ctx.measureText("M").width+5,this.ctx.font=t}"right"===i.position?e+=s:t+=s}})),n+=t,r+=e,a.xAxis.display&&(this.ctx.font=a.xAxis.labelFont,l+=1.5*this.ctx.measureText("M").width+5,a.xAxis.displayTitle&&a.xAxis.title)){const t=this.ctx.font;this.ctx.font=a.xAxis.titleFont,l+=1.5*this.ctx.measureText("M").width+5,this.ctx.font=t}}else this.ctx.font=a.percentageDistribution.labelFont,"left"===a.percentageDistribution.labelPosition&&(n=Math.max(n,(a.percentageDistribution.maxLabelWidth||0)+10)),this.ctx.font=a.percentageDistribution.valueFont,a.percentageDistribution.showValueText&&"right"===a.percentageDistribution.valuePosition&&(r=Math.max(r,this.ctx.measureText("100.0%").width+(a.percentageDistribution.valueTextMargin||0)+5));o=Math.max(5,o),r=Math.max(5,r),l=Math.max(5,l),n=Math.max(5,n);const h=this.canvas.width-n-r,c=this.canvas.height-o-l;return{x:n,y:o,width:h>0?h:0,height:c>0?c:0}}_createTooltipElement(){if(this.tooltipElement||!this.config.options.tooltip.enabled)return;this.tooltipElement=document.createElement("div"),this.tooltipElement.style.position="absolute",this.tooltipElement.style.visibility="hidden",this.tooltipElement.style.pointerEvents="none",this.tooltipElement.style.zIndex="100";const t=this.config.options.tooltip;this.tooltipElement.style.backgroundColor=t.backgroundColor,this.tooltipElement.style.color=t.color,this.tooltipElement.style.font=t.font,this.tooltipElement.style.padding=t.padding,this.tooltipElement.style.borderRadius=t.borderRadius,this.tooltipElement.style.boxShadow="0 2px 5px rgba(0,0,0,0.2)",document.body.appendChild(this.tooltipElement)}_draw(){if(this.isValid){if(!this.activePalette)if(this.config&&this.config.theme)if("dark"===this.config.theme)this.activePalette={...PC_DARK_THEME_PALETTE};else if("object"==typeof this.config.theme&&null!==this.config.theme){let t;t="dark"===this.config.theme.extends?PC_DARK_THEME_PALETTE:PC_LIGHT_THEME_PALETTE,this.activePalette=PureChart._mergeDeep({},t,this.config.theme);for(const e in t)void 0===this.activePalette[e]&&t.hasOwnProperty(e)&&"object"!=typeof t[e]?this.activePalette[e]=t[e]:"object"!=typeof t[e]||null===t[e]||Array.isArray(t[e])||(this.activePalette[e]||(this.activePalette[e]={}),this.activePalette[e]=PureChart._mergeDeep({},t[e],this.activePalette[e]));this.activePalette.name||(this.activePalette.name=t.name)}else this.activePalette={...PC_LIGHT_THEME_PALETTE};else console.error("PureChart: Cannot initialize activePalette in _draw due to missing config or theme. Using light theme as emergency fallback."),this.activePalette={...PC_LIGHT_THEME_PALETTE};if(this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.textBaseline="middle",this.interactiveElements=[],this._preprocessDatasetValues(),this.drawArea=this._getDrawingArea(),this.drawArea.width<=0||this.drawArea.height<=0)return console.warn("PureChart Warning: Drawing area too small."),this.ctx.font="12px Arial",this.ctx.fillStyle="#333",this.ctx.textAlign="center",void this.ctx.fillText("Drawing area too small.",this.canvas.width/2,this.canvas.height/2);if("percentageDistribution"!==this.config.type&&(this._calculateScale(),!this.isValid))return console.error("PureChart: Scale calculation failed."),this.ctx.font="12px Arial",this.ctx.fillStyle="red",this.ctx.textAlign="center",void this.ctx.fillText("Error: Scale calculation failed.",this.canvas.width/2,this.canvas.height/2);this.config.options.title.display&&this.config.options.title.text&&this._drawTitle(),"percentageDistribution"===this.config.type?this._drawPercentageBarChart():(this.config.options.legend.display&&this._drawLegend(),this._drawAxesAndGrid(),this._drawPeriodHighlights(),this.config.options.yAxes&&this.config.options.yAxes.length>0&&this.yAxisScales&&Object.keys(this.yAxisScales).length>0&&this._drawAnnotations(),this._drawBarChart(),this._drawLineChart(),this._drawAverageLines()),"pill"===this.config.type&&this._drawPillChart()}}_drawAverageLines(){this.config.data&&this.config.data.datasets&&"percentageDistribution"!==this.config.type&&this.yAxisScales&&(this.ctx.save(),this.config.data.datasets.forEach((t=>{const e=t.type||this.config.type;if(t._hidden||"percentageDistribution"===e||"sma"===e)return;const i=t.yAxisID||(this.config.options.yAxes&&this.config.options.yAxes.length>0?this.config.options.yAxes[0].id:null);if(!i)return;const s=this.yAxisScales[i];if(!s||!s.scale||s.scale<=0||!isFinite(s.scale)||!s.axisConfig.display)return;const a=this.config.options[e]&&this.config.options[e].averageLine?this.config.options[e].averageLine:{},o=t.averageLine||{},r=PureChart._mergeDeep(a,o);if(!r.display)return;const l=PureChart._calculateDatasetAverage(t.values);if(null===l)return;let n=this.drawArea.y+this.drawArea.height-(l-(s.min||0))*(s.scale||1);if(n=Math.max(this.drawArea.y,Math.min(n,this.drawArea.y+this.drawArea.height)),this.ctx.save(),this.ctx.beginPath(),this.ctx.moveTo(this.drawArea.x,n),this.ctx.lineTo(this.drawArea.x+this.drawArea.width,n),this.ctx.strokeStyle=r.color,this.ctx.lineWidth=r.lineWidth,Array.isArray(r.dashPattern)&&r.dashPattern.length>0&&this.ctx.setLineDash(r.dashPattern),this.ctx.stroke(),Array.isArray(r.dashPattern)&&r.dashPattern.length>0&&this.ctx.setLineDash([]),this.ctx.restore(),r.label&&r.label.display&&r.label.formatter){this.ctx.save();const t=r.label,e="function"==typeof t.formatter?t.formatter(l):String(l);let i,s;this.ctx.font=t.font,this.ctx.fillStyle=t.color;const a=t.padding||0,o=this.ctx.measureText(e),h=parseInt(this.ctx.font.match(/(\d+)px/)?.[1]||"10");let c="right",d="bottom";if(i=this.drawArea.x+this.drawArea.width-a,s=n-a,"above-left"===t.position?(c="left",i=this.drawArea.x+a):"below-left"===t.position?(c="left",d="top",i=this.drawArea.x+a,s=n+a):"below-right"===t.position&&(c="right",d="top",i=this.drawArea.x+this.drawArea.width-a,s=n+a),this.ctx.textAlign=c,this.ctx.textBaseline=d,t.backgroundColor){const e=o.width+2*a,r=h+2*a;let l=i,n=s;l="right"===c?i-o.width-a:"center"===c?i-o.width/2-a:i-a,n="bottom"===d?s-h-a:"middle"===d?s-h/2-a:s-a,this.ctx.fillStyle=t.backgroundColor,this.ctx.fillRect(l,n,e,r),this.ctx.fillStyle=t.color}this.ctx.fillText(e,i,s),this.ctx.restore()}})),this.ctx.restore())}_drawTitle(){const{text:t,font:e,color:i,padding:s}=this.config.options.title;this.ctx.save(),this.ctx.font=e,this.ctx.fillStyle=i,this.ctx.textAlign="center",this.ctx.textBaseline="top",this.ctx.fillText(t,this.canvas.width/2,s),this.ctx.restore()}_drawLegend(){const{data:t,options:e}=this.config,{legend:i}=e;if(!t.datasets||0===t.datasets.length)return;this.ctx.save(),this.interactiveLegendItems=[],this.ctx.font=i.font,this.ctx.fillStyle=i.color,this.ctx.textAlign="left",this.ctx.textBaseline="middle";const s=i.markerSize,a=Math.max(s,1.2*this.ctx.measureText("M").width);let o,r,l=e.padding.top;if(e.title.display&&e.title.text){const t=this.ctx.font;this.ctx.font=e.title.font,l=1.5*this.ctx.measureText("M").width+e.title.padding+e.padding.top,this.ctx.font=t}r="top"===i.position?l+i.padding+a/2:this.canvas.height-e.padding.bottom-i.padding-a/2;const n=t.datasets.map(((t,e)=>({label:t.label||`Dataset ${e+1}`,color:t.borderColor||(Array.isArray(t.backgroundColor)?t.backgroundColor[0]:t.backgroundColor)||"#ccc",textWidth:this.ctx.measureText(t.label||`Dataset ${e+1}`).width,dataset:t,datasetIndex:e})));if(this.config.options.periodHighlights&&this.config.options.periodHighlights.periods&&this.config.options.periodHighlights.periods.length>0&&this.config.options.periodHighlights.legendLabel){const t=this.config.options.periodHighlights.legendLabel,e=this.config.options.periodHighlights.defaultStyle?.fillColor||"#888888";n.push({label:t,color:e,textWidth:this.ctx.measureText(t).width,isPeriodToggle:!0,dataset:{_hidden:!this.showPeriodHighlights}})}const h=n.reduce(((t,e)=>t+s+5+e.textWidth+15),0)-15;o=Math.max(this.drawArea.x,this.drawArea.x+(this.drawArea.width-h)/2);const c=this.drawArea.x+this.drawArea.width;n.forEach((t=>{const e=s+5+t.textWidth+15;o+e>c&&o>Math.max(this.drawArea.x,this.drawArea.x+(this.drawArea.width-h)/2)&&(r+=a+5,o=Math.max(this.drawArea.x,this.drawArea.x+(this.drawArea.width-h)/2)),o<this.drawArea.x&&(o=this.drawArea.x);const l=o,n=l+s+5,d={x:l,y:r-a/2,w:e,h:a};this.interactiveLegendItems.push({rect:d,dataset:t.dataset,datasetIndex:t.datasetIndex,isPeriodToggle:t.isPeriodToggle||!1}),this.ctx.fillStyle=t.color,"circle"===i.markerStyle?(this.ctx.beginPath(),this.ctx.arc(l+s/2,r,s/2,0,2*Math.PI),this.ctx.fill()):this.ctx.fillRect(l,r-s/2,s,s);const x=this.ctx.fillStyle;if(t.dataset._hidden?this.ctx.fillStyle="#aaa":this.ctx.fillStyle=i.color,this.ctx.fillText(t.label,n,r),t.dataset._hidden){const e=t.textWidth;this.ctx.beginPath(),this.ctx.moveTo(n,r),this.ctx.lineTo(n+e,r),this.ctx.strokeStyle="#aaa",this.ctx.lineWidth=1,this.ctx.stroke()}this.ctx.fillStyle=x,o+=e})),this.ctx.restore()}_onCanvasClick(t){if(!this.interactiveLegendItems||0===this.interactiveLegendItems.length)return;const e=this._getMousePos(t);let i=!1;for(const t of this.interactiveLegendItems)if(e.x>=t.rect.x&&e.x<=t.rect.x+t.rect.w&&e.y>=t.rect.y&&e.y<=t.rect.y+t.rect.h&&(i=!0,t.isPeriodToggle?(this.showPeriodHighlights=!this.showPeriodHighlights,t.dataset&&(t.dataset._hidden=!this.showPeriodHighlights)):t.dataset?t.dataset._hidden=!t.dataset._hidden:i=!1,i))break;i&&this._draw()}_calculateScale(){const{data:t,options:e}=this.config;if(this.yAxisScales={},!e.yAxes||!Array.isArray(e.yAxes)||0===e.yAxes.length)return console.warn("PureChart _calculateScale: No yAxes configured. Chart may not render correctly."),this.minValue=0,this.maxValue=1,this.yScale=this.drawArea.height>0?this.drawArea.height:1,this.yAxisScales.default={min:0,max:1,scale:this.yScale,axisConfig:{id:"default",display:!0,beginAtZero:!0,position:"left"}},void(this.isValid=!1);if(e.yAxes.forEach((e=>{const i=e.id;let s,a,o,r=[];if(t.datasets&&t.datasets.length>0&&t.datasets.forEach((t=>{t.yAxisID!==i||t._hidden||t.values&&Array.isArray(t.values)&&t.values.length>0&&(r=r.concat(t.values.filter((t=>"number"==typeof t&&!isNaN(t)))))})),0===r.length)s=0,a=1;else{let t=Math.min(...r),i=Math.max(...r);e.beginAtZero?(s=Math.min(0,t),a=Math.max(0,i)):(s=t,a=i)}if(s===a)if(0===s)a=1;else{const t=Math.abs(.1*a)||1;a+=t,e.beginAtZero?s=Math.min(0,s-t):s-=t}s===a&&(a+=1),o=this.drawArea.height<=0||a-s===0?1:this.drawArea.height/(a-s),(!isFinite(o)||o<=0)&&(console.error(`PureChart _calculateScale: Invalid yScale (${o}) calculated for yAxis ID '${i}'. Defaulting to 1.`),o=1),this.yAxisScales[i]={min:s,max:a,scale:o,axisConfig:e}})),e.yAxes.length>0){const t=e.yAxes[0].id,i=this.yAxisScales[t];i?(this.minValue=i.min,this.maxValue=i.max,this.yScale=i.scale):(console.error("PureChart _calculateScale: Failed to get scale for the first Y-axis for backward compatibility."),this.minValue=0,this.maxValue=1,this.yScale=1)}else this.minValue=0,this.maxValue=1,this.yScale=1}_drawAxesAndGrid(){const{options:t,data:e}=this.config;this.ctx.save(),this.ctx.lineWidth=1,this.ctx.font=t.font;let i=null;if(t.yAxes&&Array.isArray(t.yAxes))for(const e of t.yAxes)if(e.display&&e.gridLines){i=e.id;break}this.yAxisScales&&"object"==typeof this.yAxisScales&&Object.values(this.yAxisScales).forEach((e=>{const{axisConfig:s,min:a,max:o,scale:r}=e;if(!s.display||this.drawArea.height<=0||!isFinite(r)||r<=0)return;const l="right"===s.position,n=l?this.drawArea.x+this.drawArea.width:this.drawArea.x;this.ctx.strokeStyle=s.color||this.activePalette.axisColor,this.ctx.fillStyle=s.color||this.activePalette.axisColor,this.ctx.font=s.labelFont,this.ctx.beginPath(),this.ctx.moveTo(n,this.drawArea.y),this.ctx.lineTo(n,this.drawArea.y+this.drawArea.height),this.ctx.stroke(),this.ctx.textAlign=l?"left":"right",this.ctx.textBaseline="middle";const h=Math.max(2,s.maxTicks||5);if(void 0!==o&&void 0!==a&&o-a!==0)for(let e=0;e<=h;e++){const r=o-e*(o-a)/h,c=this.drawArea.y+e*this.drawArea.height/h;if(c>=this.drawArea.y-1&&c<=this.drawArea.y+this.drawArea.height+1){const t=l?n+8:n-8;let e=r.toLocaleString("en-US");e=e.replace(/,/g," "),this.ctx.fillText(e,t,c)}s.id===i&&e>0&&e<h&&c>this.drawArea.y&&c<this.drawArea.y+this.drawArea.height&&(this.ctx.save(),this.ctx.strokeStyle=t.gridColor||this.activePalette.gridColor,this.ctx.lineWidth=.5,this.ctx.beginPath(),this.ctx.moveTo(this.drawArea.x+1,c),this.ctx.lineTo(this.drawArea.x+this.drawArea.width,c),this.ctx.stroke(),this.ctx.restore())}else if(void 0!==o){const t=l?n+8:n-8;let e=o.toLocaleString("en-US");e=e.replace(/,/g," "),this.ctx.fillText(e,t,this.drawArea.y+this.drawArea.height/2)}if(s.displayTitle&&s.title){this.ctx.save(),this.ctx.font=s.titleFont,this.ctx.textAlign="center",this.ctx.textBaseline="middle";const t=this.ctx.font;this.ctx.font=s.labelFont;const e=s.sampleLabelForWidthEstimation||(void 0!==o?o.toLocaleString():"-9,999.9"),i=this.ctx.measureText(e).width;this.ctx.font=t;const a=1.5*this.ctx.measureText("M").width;let r;l?(r=n+i+8+a/2+5,this.ctx.translate(r,this.drawArea.y+this.drawArea.height/2),this.ctx.rotate(Math.PI/2)):(r=n-i-8-a/2-5,this.ctx.translate(r,this.drawArea.y+this.drawArea.height/2),this.ctx.rotate(-Math.PI/2)),this.ctx.fillText(s.title,0,0),this.ctx.restore()}}));const s=t.xAxis;let a=null,o=null;if(i&&this.yAxisScales[i]&&this.yAxisScales[i].axisConfig.display)o=this.yAxisScales[i],a=o.axisConfig;else if(t.yAxes&&t.yAxes.length>0)for(const e of t.yAxes)if(e.display&&this.yAxisScales[e.id]){o=this.yAxisScales[e.id],a=e;break}let r=this.drawArea.y+this.drawArea.height;if(o&&o.scale>0){const t=o.min,e=o.max,i=o.scale;if(t<=0&&e>=0){let e=this.drawArea.y+this.drawArea.height-(0-t)*i;r=Math.max(this.drawArea.y,Math.min(e,this.drawArea.y+this.drawArea.height))}else e<0&&a&&a.beginAtZero&&(r=this.drawArea.y)}if(s.display&&this.drawArea.width>0){if(this.ctx.strokeStyle=s.color||this.activePalette.axisColor,this.ctx.lineWidth=1,this.ctx.beginPath(),this.ctx.moveTo(this.drawArea.x,r),this.ctx.lineTo(this.drawArea.x+this.drawArea.width,r),this.ctx.stroke(),e.labels&&e.labels.length>0){this.ctx.fillStyle=s.labelColor||this.activePalette.labelColor||this.activePalette.axisColor,this.ctx.font=s.labelFont,this.ctx.textBaseline="top";const t=e.labels,i=t.length,a=void 0===s.forceShowFirstAndLastLabel||s.forceShowFirstAndLastLabel;let o=s.maxLabelsToShow;const l=void 0!==s.minSpacingBetweenLabels?s.minSpacingBetweenLabels:5,n=r+(s.labelYOffset||8);i>0?this.drawArea.width:this.drawArea.width;if(void 0===o&&i>0){let e=0;const a=this.ctx.font;this.ctx.font=s.labelFont,t.forEach((t=>{e+=this.ctx.measureText(String(t)).width})),this.ctx.font=a;const r=i>0?e/i:0;o=r+l>0?Math.floor(this.drawArea.width/(r+l)):i,o=Math.max(1,o)}else void 0===o&&0===i&&(o=0);let h=[];if(i>0&&o>0)if(i<=o)h=t.map(((t,e)=>e));else{a&&(h.push(0),i>1&&h.push(i-1));const t=o-h.length;if(t>0){let e=[];for(let t=0;t<i;t++)h.includes(t)||e.push(t);if(e.length>0){const i=Math.max(1,Math.floor(e.length/t));for(let t=0;t<e.length&&h.length<o;t+=i)h.includes(e[t])||h.push(e[t])}}h=[...new Set(h)].sort(((t,e)=>t-e))}if("bar"===this.config.type){this.ctx.textAlign="center",this.ctx.textBaseline="top",this.ctx.fillStyle=s.labelColor||this.activePalette.labelColor||this.activePalette.axisColor,this.ctx.font=s.labelFont;const t=e.labels.length;if(t>0){const i=this.drawArea.width/t,a=i*(this.config.options.bar.groupSpacingFactor||.2),o=i-a;for(let r=0;r<t;r++){const t=this.drawArea.x+r*i+a/2+o/2,l=String(e.labels[r]);this.ctx.font=s.labelFont,this.ctx.textAlign="center",this.ctx.textBaseline="top";const h=this.ctx.measureText(l),c=s.labelFont.match(/(\d+)px/),d=c?parseInt(c[1],10):10,x={x:3,y:1},g=h.width+2*x.x,f=d+2*x.y,u=t-h.width/2-x.x,p=n-x.y,b=this.ctx.fillStyle;this.ctx.fillStyle=this.activePalette&&this.activePalette.backgroundColor?this.activePalette.backgroundColor:"white",this.ctx.fillRect(u,p,g,f),this.ctx.fillStyle=b,this.ctx.fillText(l,t,n)}}}else if(e.labels&&e.labels.length>0&&h.length>0){this.ctx.font=s.labelFont;const e=h.map((e=>{const i=String(t[e]);return{text:i,width:this.ctx.measureText(i).width,originalIndex:e}})).filter((t=>t.width>0));if(e.length>0){let t=[...e],i=[],o=0;const r=void 0!==s.minSpacingBetweenLabels?s.minSpacingBetweenLabels:5;for(;;){if(0===t.length){i=[];break}const s=t.reduce(((t,e)=>t+e.width),0);if(t.length<=1){i=[...t];break}const l=t.length-1;if(o=(this.drawArea.width-s)/l,o>=r){i=[...t];break}{if(t.length<=2&&a){i=[...t];break}if(t.length<=1){i=[...t];break}let s=Math.floor(t.length/2);if(a&&t.length>2&&(0===s?s=1:s===t.length-1&&(s=t.length-2)),0===s&&2===t.length&&a||(s>=t.length-1&&t.length>2&&a?s=t.length-2:0===s&&t.length),!(t.length>0&&s<t.length&&s>=0)){i=[...t];break}if(a&&2===t.length&&e.length>=2&&t[0].originalIndex===e[0].originalIndex&&t[1].originalIndex===e[e.length-1].originalIndex){i=[...t];break}t.splice(s,1)}}if(i.length>0)if(this.ctx.textAlign="center",this.ctx.textBaseline="top",this.ctx.fillStyle=s.labelColor||this.activePalette.labelColor||this.activePalette.axisColor,this.ctx.font=s.labelFont,1===i.length){const t=i[0];let e=this.drawArea.x+this.drawArea.width/2;t.width,this.drawArea.width,e=Math.max(e,this.drawArea.x+t.width/2),e=Math.min(e,this.drawArea.x+this.drawArea.width-t.width/2),t.width>this.drawArea.width&&(e=this.drawArea.x+this.drawArea.width/2),this.ctx.fillText(t.text,e,n)}else{const t=i.reduce(((t,e)=>t+e.width),0),e=Math.max(r,(this.drawArea.width-t)/(i.length-1));let a=this.drawArea.x;i.length;this.drawArea.width,i.forEach(((t,i)=>{const o=a+t.width/2,r=t.text,l=t.width,h=s.labelFont.match(/(\d+)px/),c=3,d=1,x=l+2*c,g=(h?parseInt(h[1],10):10)+2*d,f=o-l/2-c,u=n-d,p=this.ctx.fillStyle;this.ctx.fillStyle=this.activePalette&&this.activePalette.backgroundColor?this.activePalette.backgroundColor:"white",this.ctx.fillRect(f,u,x,g),this.ctx.fillStyle=p,this.ctx.fillText(r,o,n),a+=l+e}))}}}}s.displayTitle&&s.title&&(this.ctx.font=s.titleFont,this.ctx.fillStyle=s.titleColor||this.activePalette.titleColor||this.activePalette.axisColor,this.ctx.textAlign="center",this.ctx.textBaseline="bottom",this.ctx.fillText(s.title,this.drawArea.x+this.drawArea.width/2,this.canvas.height-t.padding.bottom/2))}this.ctx.restore()}_fillRoundRect(t,e,i,s,a,o){if(s<=0||a<=0)return;let r=0,l=0,n=0,h=0;"number"==typeof o?r=l=n=h=Math.max(0,o):"object"==typeof o&&null!==o&&(r=Math.max(0,o.tl||0),l=Math.max(0,o.tr||0),n=Math.max(0,o.br||0),h=Math.max(0,o.bl||0));const c=s/2,d=a/2;r=Math.min(r,c,d),l=Math.min(l,c,d),n=Math.min(n,c,d),h=Math.min(h,c,d),r<=0&&l<=0&&n<=0&&h<=0?t.fillRect(e,i,s,a):(t.beginPath(),t.moveTo(e+r,i),t.lineTo(e+s-l,i),l>0&&t.arcTo(e+s,i,e+s,i+l,l),t.lineTo(e+s,i+a-n),n>0&&t.arcTo(e+s,i+a,e+s-n,i+a,n),t.lineTo(e+h,i+a),h>0&&t.arcTo(e,i+a,e,i+a-h,h),t.lineTo(e,i+r),r>0&&t.arcTo(e,i,e+r,i,r),t.closePath(),t.fill())}_strokeRoundRect(t,e,i,s,a,o,r=1){if(s<=0||a<=0||r<=0)return;let l=0,n=0,h=0,c=0;"number"==typeof o?l=n=h=c=Math.max(0,o):"object"==typeof o&&null!==o&&(l=Math.max(0,o.tl||0),n=Math.max(0,o.tr||0),h=Math.max(0,o.br||0),c=Math.max(0,o.bl||0));const d=s/2,x=a/2;l=Math.min(l,d,x),n=Math.min(n,d,x),h=Math.min(h,d,x),c=Math.min(c,d,x),l<=0&&n<=0&&h<=0&&c<=0?t.strokeRect(e,i,s,a):(t.beginPath(),t.moveTo(e+l,i),t.lineTo(e+s-n,i),n>0&&t.arcTo(e+s,i,e+s,i+n,n),t.lineTo(e+s,i+a-h),h>0&&t.arcTo(e+s,i+a,e+s-h,i+a,h),t.lineTo(e+c,i+a),c>0&&t.arcTo(e,i+a,e,i+a-c,c),t.lineTo(e,i+l),l>0&&t.arcTo(e,i,e+l,i,l),t.closePath(),t.stroke())}_drawPercentageBarChart(){if(!this.config.data||!Array.isArray(this.config.data.items))return console.error("PureChart Error (_drawPercentageBarChart): data.items is missing or not an array."),this.ctx.font="12px Arial",this.ctx.fillStyle="red",this.ctx.textAlign="center",void this.ctx.fillText("Error: Invalid data for percentage chart.",this.canvas.width/2,this.canvas.height/2);const{items:t}=this.config.data,e=this.config.options.percentageDistribution,i=this.drawArea;let s=[...t];if(e.valuesArePercentages)s.forEach((t=>{let e="number"!=typeof t.value||isNaN(t.value)?0:t.value;t.percentage=Math.max(0,Math.min(100,e))}));else{const t=s.reduce(((t,e)=>t+("number"!=typeof e.value||isNaN(e.value)?0:e.value)),0);s.forEach((e=>{const i="number"!=typeof e.value||isNaN(e.value)?0:e.value;e.percentage=0===t?0:i/t*100}))}"ascending"===e.sort?s.sort(((t,e)=>t.value-e.value)):"descending"===e.sort&&s.sort(((t,e)=>e.value-t.value));const a=i.x,o=i.width;if(o<=0)return console.warn(`PureChart Warning: Not enough width for percentage bar drawing area. PlotAreaWidth: ${o}`),this.ctx.font="12px Arial",this.ctx.fillStyle="orange",this.ctx.textAlign="center",void this.ctx.fillText("Not enough space for bars.",this.canvas.width/2,this.canvas.height/2);let r=i.y+e.barSpacing/2;s.forEach(((t,l)=>{if(r+e.barHeight>i.y+i.height+e.barSpacing)return;const n=this._getAutoColor(l,s.length),h=Math.max(0,t.percentage/100*o),c=r+e.barHeight/2,d=e.fillLightenPercent;let x=void 0!==e.borderWidth?e.borderWidth:1;const g="string"==typeof this.config.options.contourColor&&this.config.options.contourColor?this.config.options.contourColor:null;if(g)this.ctx.fillStyle=this.activePalette.backgroundColor,this.ctx.strokeStyle=g,this.ctx.lineWidth=x,h>0&&(this._fillRoundRect(this.ctx,a,r,h,e.barHeight,e.barBorderRadius),this._strokeRoundRect(this.ctx,a,r,h,e.barHeight,e.barBorderRadius,this.ctx.lineWidth));else if(void 0!==d&&d>0&&"number"==typeof d){const t=n,i=this._lightenColor(n,d);h>0&&(this.ctx.fillStyle=this._resolveColor(i,{x:a,y:r,w:h,h:e.barHeight}),this._fillRoundRect(this.ctx,a,r,h,e.barHeight,e.barBorderRadius),x>0&&(this.ctx.strokeStyle=this._resolveColor(t,{x:a,y:r,w:h,h:e.barHeight}),this.ctx.lineWidth=x,this._strokeRoundRect(this.ctx,a,r,h,e.barHeight,e.barBorderRadius,x)))}else{const t=n;if(this.ctx.fillStyle=this._resolveColor(t,{x:a,y:r,w:h,h:e.barHeight}),this._fillRoundRect(this.ctx,a,r,h,e.barHeight,e.barBorderRadius),x>0){let i=e.borderColor;if(void 0===i){const s=this._resolveColor(t,{x:a,y:r,w:h,h:e.barHeight});i="string"==typeof s?this._darkenColor(s,void 0!==e.borderDarkenPercent?e.borderDarkenPercent:20):"#333333"}i&&"transparent"!==i&&(this.ctx.strokeStyle=i,this.ctx.lineWidth=x,this._strokeRoundRect(this.ctx,a,r,h,e.barHeight,e.barBorderRadius,x))}}if("left"===e.labelPosition&&(this.ctx.font=e.labelFont,this.ctx.fillStyle=e.labelColor,this.ctx.textAlign="right",this.ctx.textBaseline="middle",this.ctx.fillText(t.label,a-10,c,e.maxLabelWidth||void 0)),"insideStart"===e.labelPosition&&(this.ctx.font=e.labelFont,this.ctx.fillStyle=e.labelColor,this.ctx.textAlign="left",this.ctx.textBaseline="middle",this.ctx.measureText(t.label).width+10<h&&this.ctx.fillText(t.label,a+5+(e.barBorderRadius/2||0),c)),e.showValueText){this.ctx.font=e.valueFont,this.ctx.fillStyle=e.valueColor,this.ctx.textBaseline="middle";const i=`${t.percentage.toFixed(1)}%`;"right"===e.valuePosition?(this.ctx.textAlign="left",this.ctx.fillText(i,a+h+(e.valueTextMargin||0),c)):"insideEnd"===e.valuePosition&&(this.ctx.textAlign="right",this.ctx.measureText(i).width+10<h&&this.ctx.fillText(i,a+h-5-(e.barBorderRadius/2||0),c))}const f={x:a,y:r,w:h,h:e.barHeight};this.interactiveElements.push({type:"percentageDistribution",rect:f,item:{...t},index:l}),r+=e.barHeight+e.barSpacing}))}_getBarRect(t,e,i,s,a,o){const r=this.config.options.bar,l=a*(1-r.itemSpacingFactor*(s>1?s-1:0))/s,n=e*(l+l*r.itemSpacingFactor),h=parseFloat(t)||0,c=o.min||0,d=o.scale||1,x=this.drawArea.y+this.drawArea.height-(0-c)*d;let g,f=Math.abs(h*d);return g=h>=0?x-f:x,g<this.drawArea.y&&(f-=this.drawArea.y-g,g=this.drawArea.y),g+f>this.drawArea.y+this.drawArea.height&&(f=this.drawArea.y+this.drawArea.height-g),f<0&&(f=0),{x:n,y:g,w:l>0?l:0,h:f}}_drawBarChart(){const{data:t,options:e,type:i}=this.config;if(!t.labels||0===t.labels.length||!t.datasets||0===t.datasets.length)return;const s=t.datasets.filter((t=>{const e=t.type||i;return!t._hidden&&"bar"===e}));if(0===s.length)return;const a=t.labels.length,o=s.length,r=this.drawArea.width/a,l=r*e.bar.groupSpacingFactor,n=r-l;n<=0&&o>0?console.warn("PureChart: Not enough width for bar groups."):t.labels.forEach(((i,a)=>{const h=this.drawArea.x+a*r+l/2;s.forEach(((s,r)=>{const l=s.yAxisID||(e.yAxes&&e.yAxes.length>0?e.yAxes[0].id:null);if(!l)return void console.warn(`PureChart _drawBarChart: Dataset '${s.label}' has no yAxisID.`);const c=this.yAxisScales[l];if(!c||!c.scale||c.scale<=0||!isFinite(c.scale))return void console.warn(`PureChart _drawBarChart: Invalid Y-axis scale for dataset '${s.label}' on yAxisID '${l}'. Skipping bar.`);const d=t.datasets.indexOf(s),x=s.values&&s.values.length>a&&"number"==typeof s.values[a]&&!isNaN(s.values[a])?s.values[a]:0,g=this._getBarRect(x,r,a,o,n,c);if(g.w<=0)return;const f={x:h+g.x,y:g.y,w:g.w,h:g.h},u="string"==typeof e.contourColor&&e.contourColor?e.contourColor:null;let p=s.borderWidth;if(void 0===p&&(p=void 0!==e.bar.defaultBorderWidth?e.bar.defaultBorderWidth:1),this.ctx.lineWidth=p,u)this.ctx.fillStyle=this.activePalette.backgroundColor,this.ctx.strokeStyle=u;else{const t=this.activePalette.defaultDatasetColors[d%this.activePalette.defaultDatasetColors.length],i=s.backgroundColor||t,a=this._resolveColor(i,f);this.ctx.fillStyle=a;let o=s.borderColor;!o&&p>0&&(o="string"==typeof a?this._darkenColor(a,void 0!==e.bar.borderDarkenPercent?e.bar.borderDarkenPercent:20):this.activePalette.axisColor),this.ctx.strokeStyle=o||"transparent"}const b=e.bar.topCornerRadius||0;if(b>0&&f.h>0){let t;t=x>=0?{tl:b,tr:b,bl:0,br:0}:{tl:0,tr:0,bl:b,br:b},this._fillRoundRect(this.ctx,f.x,f.y,f.w,f.h,t),p>0&&"transparent"!==this.ctx.strokeStyle&&this._strokeRoundRect(this.ctx,f.x,f.y,f.w,f.h,t,p)}else f.h>0&&(this.ctx.fillRect(f.x,f.y,f.w,f.h),p>0&&"transparent"!==this.ctx.strokeStyle&&this.ctx.strokeRect(f.x,f.y,f.w,f.h));this.interactiveElements.push({type:"bar",rect:f,xLabel:i,dataset:s,value:x,datasetIndex:d,pointIndex:a})}))}))}_getControlPointsForSegment(t,e,i,s,a){a="number"==typeof a&&isFinite(a)?a:0;const o=(i.x-t.x)*a,r=(i.y-t.y)*a,l=(s.x-e.x)*a,n=(s.y-e.y)*a;return{cp1:{x:e.x+o,y:e.y+r},cp2:{x:i.x-l,y:i.y-n}}}_drawLineChart(){const{data:t,options:e,type:i}=this.config,s=e.line;t.datasets&&0!==t.datasets.length&&t.datasets.forEach(((a,o)=>{const r=a.type||i;if(a._hidden||"line"!==r&&"sma"!==r)return;if(!a.values||!Array.isArray(a.values)||a.values.length<1)return;this.ctx.save();const l=a.yAxisID||(e.yAxes&&e.yAxes.length>0?e.yAxes[0].id:null);if(!l)return console.warn(`PureChart _drawLineChart: Dataset '${a.label}' has no yAxisID.`),void this.ctx.restore();const n=this.yAxisScales[l];if(!n||!n.scale||n.scale<=0||!isFinite(n.scale))return console.warn(`PureChart _drawLineChart: Invalid Y-axis scale for dataset '${a.label}' on yAxisID '${l}'. Skipping line.`),void this.ctx.restore();const h=a.values.map(((e,i)=>{const r=this._getPointPosition(e,i,n);return this.interactiveElements.push({type:"point",pos:r,radius:void 0!==a.pointRadius?a.pointRadius:void 0!==s.pointRadius?s.pointRadius:3,xLabel:t.labels&&void 0!==t.labels[i]?String(t.labels[i]):`Index ${i}`,dataset:a,value:e,datasetIndex:o,pointIndex:i}),r}));if(0===h.length)return void this.ctx.restore();const c=void 0!==a.tension?a.tension:s.tension,d=void 0!==a.lineWidth?a.lineWidth:s.lineWidth,x="string"==typeof e.contourColor&&e.contourColor?e.contourColor:null;if(a.fill&&h.length>1){this.ctx.beginPath();const t=this.drawArea.y+this.drawArea.height-(0-(n.min||0))*(n.scale||1),e=Math.max(this.drawArea.y,Math.min(this.drawArea.y+this.drawArea.height,t));if(this.ctx.moveTo(h[0].x,e),this.ctx.lineTo(h[0].x,h[0].y),c>0)for(let t=0;t<h.length-1;t++){const e=h[0===t?0:t-1],i=h[t],s=h[t+1],a=h[t+2<h.length?t+2:t+1],{cp1:o,cp2:r}=this._getControlPointsForSegment(e,i,s,a,.2*c);this.ctx.bezierCurveTo(o.x,o.y,r.x,r.y,s.x,s.y)}else for(let t=1;t<h.length;t++)this.ctx.lineTo(h[t].x,h[t].y);this.ctx.lineTo(h[h.length-1].x,e),this.ctx.closePath();const i=h.map((t=>t.y)).concat([e]),s={x:this.drawArea.x,y:Math.min(...i),w:this.drawArea.width,h:Math.abs(Math.max(...i)-Math.min(...i))};if(x)this.ctx.fillStyle=this.activePalette.backgroundColor;else{const t=this.activePalette.defaultDatasetColors[o%this.activePalette.defaultDatasetColors.length],e=a.backgroundColor||t;this.ctx.fillStyle=this._resolveColor(e,s)}this.ctx.fill()}if(d>0&&h.length>0){if(this.ctx.beginPath(),this.ctx.moveTo(h[0].x,h[0].y),c>0&&h.length>1)for(let t=0;t<h.length-1;t++){const e=h[0===t?0:t-1],i=h[t],s=h[t+1],a=h[t+2<h.length?t+2:t+1],{cp1:o,cp2:r}=this._getControlPointsForSegment(e,i,s,a,.2*c);this.ctx.bezierCurveTo(o.x,o.y,r.x,r.y,s.x,s.y)}else if(h.length>1)for(let t=1;t<h.length;t++)this.ctx.lineTo(h[t].x,h[t].y);if(x)this.ctx.strokeStyle=x;else{const t=this.activePalette.defaultDatasetColors[o%this.activePalette.defaultDatasetColors.length],e=a.borderColor||t;this.ctx.strokeStyle=this._resolveColor(e,this.drawArea)}this.ctx.lineWidth=d;let t=!1;a.borderDash&&Array.isArray(a.borderDash)&&a.borderDash.length>0&&(this.ctx.setLineDash(a.borderDash),t=!0),this.ctx.stroke(),t&&this.ctx.setLineDash([])}const g=void 0!==a.pointRadius?a.pointRadius:void 0!==s.pointRadius?s.pointRadius:3,f=void 0!==a.pointBorderWidth?a.pointBorderWidth:1;g>0&&h.length>0&&h.forEach((t=>{const e={x:t.x-g,y:t.y-g,w:2*g,h:2*g};if(x)this.ctx.fillStyle=this.activePalette.backgroundColor,this.ctx.strokeStyle=x,this.ctx.lineWidth=f>0?f:1;else{let t=a.pointColor;void 0===t&&(t=a.fill&&a.backgroundColor?a.borderColor||this.activePalette.defaultDatasetColors[o%this.activePalette.defaultDatasetColors.length]:a.backgroundColor||a.borderColor||this.activePalette.defaultDatasetColors[o%this.activePalette.defaultDatasetColors.length]),this.ctx.fillStyle=this._resolveColor(t,e),a.pointBorderColor&&f>0?(this.ctx.strokeStyle=this._resolveColor(a.pointBorderColor,e),this.ctx.lineWidth=f):this.ctx.strokeStyle="transparent"}this.ctx.beginPath();"square"===(a.pointStyle||s.pointStyle||"circle")?this.ctx.rect(e.x,e.y,e.w,e.h):this.ctx.arc(t.x,t.y,g,0,2*Math.PI),this.ctx.fill(),"transparent"!==this.ctx.strokeStyle&&f>0&&this.ctx.stroke()})),this.ctx.restore()}))}_getPointPosition(t,e,i){const s=this.config.data.labels?this.config.data.labels.length:0;if(0===s||0===this.drawArea.width)return{x:this.drawArea.x+this.drawArea.width/2,y:this.drawArea.y+this.drawArea.height/2};const a=s>1?this.drawArea.width/(s-1):this.drawArea.width/2,o=this.drawArea.x+e*a,r=parseFloat(t);if(isNaN(r))return{x:o,y:this.drawArea.y+this.drawArea.height/2};const l=i.min||0,n=i.scale||1;let h=this.drawArea.y+this.drawArea.height-(r-l)*n;return isFinite(h)||(h=this.drawArea.y+this.drawArea.height/2),h=Math.max(this.drawArea.y,Math.min(h,this.drawArea.y+this.drawArea.height)),{x:o,y:h}}_findXCoordinateForDate(t){const e=this.config.data.labels,i=this.drawArea;if(!e||0===e.length||!i||void 0===i.width)return null;const s=new Date(t).getTime();if(isNaN(s))return null;let a=-1,o=1/0;for(let t=0;t<e.length;t++){const i=new Date(e[t]).getTime();if(isNaN(i))continue;const r=Math.abs(i-s);r<o&&(o=r,a=t)}if(-1===a)return null;const r=e.length,l=r>1?i.width/(r-1):i.width/2;return i.x+a*l}_getMousePos(t){const e=this.canvas.getBoundingClientRect();return{x:t.clientX-e.left,y:t.clientY-e.top}}_onMouseMove(t){if(!this.tooltipElement||!this.config.options.tooltip.enabled||!this.interactiveElements)return;const e=this._getMousePos(t),i=this.canvas.getBoundingClientRect();let s=null,a=1/0;for(let t=this.interactiveElements.length-1;t>=0;t--){const i=this.interactiveElements[t];let o=!1;if("point"===i.type&&i.pos){const t=(void 0!==i.radius?i.radius:void 0!==this.config.options.line.pointRadius?this.config.options.line.pointRadius:3)+3,r=e.x-i.pos.x,l=e.y-i.pos.y,n=r*r+l*l;n<=t*t&&(n<a&&(a=n,s=i),o=!0)}else if(("bar"===i.type||"percentageDistribution"===i.type)&&i.rect&&e.x>=i.rect.x&&e.x<=i.rect.x+i.rect.w&&e.y>=i.rect.y&&e.y<=i.rect.y+i.rect.h){s=i;break}}if(s){let t,a,o;if("percentageDistribution"===s.type)a=s.rect.x+s.rect.w/2+i.left,o=s.rect.y+s.rect.h/2+i.top,t={type:"percentageDistribution",item:s.item,themePalette:this.activePalette};else if("bar"===s.type||"point"===s.type){const r=s.pointIndex,l=this.config.data.labels&&this.config.data.labels.length>r?String(this.config.data.labels[r]):s.xLabel||`Index ${r}`;let n=[];(this.config.data.datasets||[]).forEach(((t,e)=>{if(t._hidden)return;if("percentageDistribution"===(t.type||this.config.type))return;const i=t.values&&t.values.length>r&&null!==t.values[r]&&void 0!==t.values[r]?t.values[r]:void 0;let s=t.borderColor||t.backgroundColor;if(Array.isArray(s)&&(s=s[0]),!s){const t=this.activePalette||PC_LIGHT_THEME_PALETTE;s=t.defaultDatasetColors[e%t.defaultDatasetColors.length]}n.push({dataset:{label:t.label||`Dataset ${e+1}`,color:s,originalIndex:e},value:i})})),n.length>0&&("point"===s.type&&s.pos?(a=s.pos.x+i.left,o=s.pos.y+i.top):"bar"===s.type&&s.rect?(a=s.rect.x+s.rect.w/2+i.left,o=s.rect.y+i.top):(a=e.x+i.left,o=e.y+i.top),t={type:"shared",xLabel:l,datasets:n,themePalette:this.activePalette})}if(t){t.anchorX=a,t.anchorY=o;const e=JSON.stringify(t);this.activeTooltipData&&this.activeTooltipData.signature===e?this._positionTooltip(a,o):(this.activeTooltipData={signature:e,data:t},this._showTooltip(t)),this.canvas.style.cursor="pointer"}else this._onMouseOut()}else this._onMouseOut()}_showTooltip(t){this.tooltipElement&&this.config.options.tooltip.enabled&&(this.tooltipElement.innerHTML=this.config.options.tooltip.formatter(t),this.tooltipElement.style.visibility="visible",this._positionTooltip(t.anchorX,t.anchorY))}_positionTooltip(t,e){if(!this.tooltipElement||"hidden"===this.tooltipElement.style.visibility)return;this.tooltipElement.style.backgroundColor=this.activePalette.tooltipBgColor,this.tooltipElement.style.color=this.activePalette.tooltipColor;const i=this.tooltipElement.getBoundingClientRect(),s=i.width,a=i.height,o=this.config.options.tooltip.offset||10,r=window.scrollX||window.pageXOffset,l=window.scrollY||window.pageYOffset,n=window.innerWidth,h=window.innerHeight;let c=t+r-s/2,d=e+l-a-o;if(d-l<5&&(d=e+l+o),d-l+a>h-5){let t=e+l-a-o;t-l>=5?d=t:(d=l+h-a-5,d-l<5&&(d=l+5))}c-r<5&&(c=r+5),c-r+s>n-5&&(c=r+n-s-5),c-r<5&&(c=r+5),this.tooltipElement.style.left=`${c}px`,this.tooltipElement.style.top=`${d}px`}_onMouseOut(){this.tooltipElement&&this.config.options.tooltip.enabled&&(this.tooltipElement.style.visibility="hidden"),this.activeTooltipData=null,this.canvas&&(this.canvas.style.cursor="default")}_drawAnnotations(){const t=this.config.options.annotations;if(!(t&&Array.isArray(t)&&0!==t.length&&this.config.options.yAxes&&0!==this.config.options.yAxes.length&&this.yAxisScales&&0!==Object.keys(this.yAxisScales).length))return;const e=this.config.options.yAxes[0].id;this.ctx.save(),t.forEach((t=>{if("line"!==t.type||"horizontal"!==t.mode)return;const i=t.yAxisID||e,s=this.yAxisScales[i];if(!s||!s.scale||s.scale<=0||!isFinite(s.scale)||!s.axisConfig||!s.axisConfig.display)return;const{min:a,max:o,scale:r}=s;let l=null;if(void 0!==t.value)l=this.drawArea.y+this.drawArea.height-(t.value-a)*r;else if(void 0!==t.percentage&&"number"==typeof t.percentage){const e=o-a;let i;i=0===e?a:a+t.percentage/100*e,l=this.drawArea.y+this.drawArea.height-(i-a)*r}if(null===l||isNaN(l)||!isFinite(l))return void console.warn(`PureChart Annotation: Could not determine Y position for annotation on Y-axis ID '${i}'.`,t);l=Math.max(this.drawArea.y,Math.min(l,this.drawArea.y+this.drawArea.height)),this.ctx.save(),this.ctx.beginPath(),this.ctx.moveTo(this.drawArea.x,l),this.ctx.lineTo(this.drawArea.x+this.drawArea.width,l),this.ctx.strokeStyle=t.borderColor||this.activePalette.gridColor,this.ctx.lineWidth=t.borderWidth||1;let n=!1;if(t.borderDash&&Array.isArray(t.borderDash)&&t.borderDash.length>0&&(this.ctx.setLineDash(t.borderDash),n=!0),this.ctx.stroke(),n&&this.ctx.setLineDash([]),this.ctx.restore(),t.label&&t.label.text){this.ctx.save();const e=t.label,i=this.config.options.font||"10px Arial";this.ctx.font=e.font||i;const a=e.color||s.axisConfig.color||this.activePalette.axisColor;let o,r;this.ctx.fillStyle=a;let n="right",h="bottom";const c=void 0===e.padding?2:e.padding,d={x:"object"==typeof c?c.x||0:c,y:"object"==typeof c?c.y||0:c};switch(e.position||"right"){case"left":case"top-left":n="left",h="bottom",o=this.drawArea.x+d.x,r=l-d.y;break;case"bottom-left":n="left",h="top",o=this.drawArea.x+d.x,r=l+d.y;break;case"top-right":case"right":default:n="right",h="bottom",o=this.drawArea.x+this.drawArea.width-d.x,r=l-d.y;break;case"bottom-right":n="right",h="top",o=this.drawArea.x+this.drawArea.width-d.x,r=l+d.y;break;case"center":n="center",h="bottom",o=this.drawArea.x+this.drawArea.width/2,r=l-d.y}if(this.ctx.textAlign=n,this.ctx.textBaseline=h,e.backgroundColor){const t=this.ctx.measureText(e.text),i=parseInt(this.ctx.font.match(/(\d+)px/)?.[1]||"10"),s=t.width+2*d.x,l=i+2*d.y;let c=o;c="right"===n?o-t.width-d.x:"center"===n?o-t.width/2-d.x:o-d.x;let x=r;x="bottom"===h?r-i-d.y:"middle"===h?r-i/2-d.y:r-d.y,this.ctx.fillStyle=e.backgroundColor,this.ctx.fillRect(c,x,s,l),this.ctx.fillStyle=a}this.ctx.fillText(e.text,o,r),this.ctx.restore()}})),this.ctx.restore()}_drawPeriodHighlights(){if(!this.showPeriodHighlights)return;const t=this.config.options.periodHighlights;if(!t||!t.periods||0===t.periods.length)return;const e=this.drawArea;e&&t.periods.forEach((i=>{const s=this._findXCoordinateForDate(i.startDate),a=this._findXCoordinateForDate(i.endDate);if(null===s||null===a||s>=a)return;const o=t.defaultStyle||{},r=i.style||{},l={...o,...r,label:{...o.label||{},...r.label||{}}};if(l.fillColor&&(this.ctx.fillStyle=l.fillColor,this.ctx.fillRect(s,e.y,a-s,e.height)),l.borderWidth>0&&l.borderColor&&(this.ctx.strokeStyle=l.borderColor,this.ctx.lineWidth=l.borderWidth,this.ctx.strokeRect(s,e.y,a-s,e.height)),i.name&&l.label){let t,o;this.ctx.save(),this.ctx.font=l.label.font||"10px Arial",this.ctx.fillStyle=l.label.color||"#000000",this.ctx.textAlign=l.label.textAlign||"center",this.ctx.textBaseline="middle";const r=s+(a-s)/2,n=e.y+e.height/2,h=l.label.offset||5;switch(l.label.position){case"center":t=r,o=n;break;case"below":t=r,o=e.y+e.height+h+this.ctx.measureText("M").width/2,l.label.angle&&l.label.angle%360!=0&&(o+=Math.abs(Math.sin(l.label.angle*Math.PI/180)*(this.ctx.measureText(i.name).width/2)));break;default:t=r,o=e.y-h-this.ctx.measureText("M").width/2,l.label.angle&&l.label.angle%360!=0&&(o-=Math.abs(Math.sin(l.label.angle*Math.PI/180)*(this.ctx.measureText(i.name).width/2)))}this.ctx.translate(t,o),this.ctx.rotate((l.label.angle||0)*Math.PI/180),this.ctx.fillText(i.name,0,0),this.ctx.restore()}}))}_preprocessDatasetValues(){if(!this.config.data||!this.config.data.datasets)return;if("pill"===this.config.type&&(!this.config.data.datasets||0===this.config.data.datasets.length))return;const t=this.config.data.datasets,e=this.config.data.labels?this.config.data.labels.length:0;t.forEach(((i,s)=>{if("sma"===i.type){let a=!0,o=null;"number"!=typeof i.sourceDatasetIndex||i.sourceDatasetIndex<0||i.sourceDatasetIndex>=t.length?(console.warn(`PureChart SMA Error: Dataset ${s} ('${i.label}') has invalid sourceDatasetIndex ${i.sourceDatasetIndex}.`),a=!1):(o=t[i.sourceDatasetIndex],"sma"===o.type&&(console.warn(`PureChart SMA Error: Dataset ${s} ('${i.label}') sourceDatasetIndex ${i.sourceDatasetIndex} ('${o.label}') is another SMA. Chaining SMAs is not supported.`),a=!1,o=null),i.sourceDatasetIndex===s&&(console.warn(`PureChart SMA Error: Dataset ${s} ('${i.label}') sourceDatasetIndex cannot be itself.`),a=!1,o=null)),("number"!=typeof i.period||i.period<=0)&&(console.warn(`PureChart SMA Error: Dataset ${s} ('${i.label}') has invalid period ${i.period}.`),a=!1),a&&o?o._hidden?i.values=e>0?new Array(e).fill(null):[]:o.values&&0!==o.values.length?(i.values=PureChart._calculateSMA(o.values,i.period),0===i.values.length&&o.values.length>0&&console.warn(`PureChart SMA Warning: Dataset ${s} ('${i.label}') period ${i.period} is greater than source data length ${o.values.length}. Resulting in empty SMA.`)):(console.warn(`PureChart SMA Error: Source dataset ${i.sourceDatasetIndex} ('${o.label}') for SMA dataset ${s} ('${i.label}') has no values.`),i.values=e>0?new Array(e).fill(null):[]):i.values=e>0?new Array(e).fill(null):[]}}))}destroy(){this.isValid&&(this.canvas&&(this.config&&this.config.options&&this.config.options.tooltip&&this.config.options.tooltip.enabled&&(this._boundOnMouseMove&&this.canvas.removeEventListener("mousemove",this._boundOnMouseMove),this._boundOnMouseOut&&(this.canvas.removeEventListener("mouseout",this._boundOnMouseOut),this.canvas.removeEventListener("mouseleave",this._boundOnMouseOut))),this._boundOnCanvasClick&&this.canvas.removeEventListener("click",this._boundOnCanvasClick)),this.tooltipElement&&(this.tooltipElement.parentElement&&this.tooltipElement.remove(),this.tooltipElement=null),this.resizeObserver&&(this.resizeObserver.disconnect(),this.resizeObserver=null),this.debouncedResize&&(this.debouncedResize=null),this.ctx=null,this.canvas=null,this.config&&(this.config=null),this.interactiveElements=[],this.interactiveLegendItems=[],this.activeTooltipData=null,this.yAxisScales=null,this.drawArea=null,this._boundOnMouseMove=null,this._boundOnMouseOut=null,this._boundOnCanvasClick=null,this.isValid=!1)}_drawPillChart(){const t=this.config.options.pill,e=this.drawArea;if(!e||e.width<=0||t.pillHeight<=0)return console.warn("PureChart (Pill): Invalid drawing area or pill dimensions."),this.ctx.font="12px Arial",this.ctx.fillStyle="orange",this.ctx.textAlign="center",void this.ctx.fillText("Pill Chart: Invalid dimensions.",this.canvas.width/2,this.canvas.height/2);if(t.max<=t.min)return this.ctx.font="12px Arial",this.ctx.fillStyle="red",this.ctx.textAlign="center",void this.ctx.fillText("Error: Max must be greater than Min for Pill Chart.",e.x+e.width/2,e.y+e.height/2);const i=e.width/(t.max-t.min),s=s=>{const a=Math.max(t.min,Math.min(t.max,s));return e.x+(a-t.min)*i},a=e.y+e.height/2-t.pillHeight/2,o=t.zoneOverflowAmount||0,r=t.pillBorderWidth,l=t.fillLightenPercent,n=t.colors.mainBackground,h=this._lightenColor(n,l);this.ctx.fillStyle=h,this._fillRoundRect(this.ctx,e.x,a,e.width,t.pillHeight,t.borderRadius),r>0&&(this.ctx.strokeStyle=n,this.ctx.lineWidth=r,this._strokeRoundRect(this.ctx,e.x,a,e.width,t.pillHeight,t.borderRadius,r));const c=t.zoneMin,d=t.zoneMax,x=Math.max(t.min,Math.min(t.max,c)),g=Math.max(t.min,Math.min(t.max,d));if(g>x){const i=s(x),n=s(g)-i;if(n>0){const s=t.colors.zoneBackground,h=this._lightenColor(s,l);this.ctx.save(),this.ctx.beginPath(),this.ctx.moveTo(e.x+t.borderRadius,a),this.ctx.lineTo(e.x+e.width-t.borderRadius,a),t.borderRadius>0&&this.ctx.arcTo(e.x+e.width,a,e.x+e.width,a+t.borderRadius,t.borderRadius),this.ctx.lineTo(e.x+e.width,a+t.pillHeight-t.borderRadius),t.borderRadius>0&&this.ctx.arcTo(e.x+e.width,a+t.pillHeight,e.x+e.width-t.borderRadius,a+t.pillHeight,t.borderRadius),this.ctx.lineTo(e.x+t.borderRadius,a+t.pillHeight),t.borderRadius>0&&this.ctx.arcTo(e.x,a+t.pillHeight,e.x,a+t.pillHeight-t.borderRadius,t.borderRadius),this.ctx.lineTo(e.x,a+t.borderRadius),t.borderRadius>0&&this.ctx.arcTo(e.x,a,e.x+t.borderRadius,a,t.borderRadius),this.ctx.closePath(),this.ctx.clip();const c=a-o,d=t.pillHeight+2*o;this.ctx.fillStyle=h,this.ctx.fillRect(i,c,n,d),r>0&&(this.ctx.strokeStyle=s,this.ctx.lineWidth=r,this.ctx.strokeRect(i,c,n,d)),this.ctx.restore()}}const f=s(t.value);if(this.ctx.strokeStyle=t.colors.cursor,this.ctx.lineWidth=t.cursorThickness,this.ctx.lineCap="round",this.ctx.beginPath(),this.ctx.moveTo(f,a-t.cursorLengthExtension),this.ctx.lineTo(f,a+t.pillHeight+t.cursorLengthExtension),this.ctx.stroke(),t.showMinMaxLabels){this.ctx.font=t.mainLabelFont||t.labelFont,this.ctx.fillStyle=t.colors.minMaxText;const i=t.minMaxLabelPosition,s=a+t.pillHeight/2;let o,r,l,n,h,c;const d=t.zoneLabelOffset||5;switch(i){case"aboveEnds":l=a-d,c="bottom",n="left",h="right",o=e.x+(t.borderRadius/2||0)+2,r=e.x+e.width-(t.borderRadius/2||0)-2;break;case"belowEnds":l=a+t.pillHeight+d,c="top",n="left",h="right",o=e.x+(t.borderRadius/2||0)+2,r=e.x+e.width-(t.borderRadius/2||0)-2;break;default:l=s,c="middle",n="left",h="right",o=Math.max(e.x+2,e.x+t.borderRadius/2+2),r=Math.min(e.x+e.width-2,e.x+e.width-t.borderRadius/2-2)}this.ctx.textAlign=n,this.ctx.textBaseline=c,this.ctx.fillText(String(t.min),o,l),this.ctx.textAlign=h,this.ctx.fillText(String(t.max),r,l)}if(t.showValueLabel){let e;this.ctx.font=t.mainLabelFont||t.labelFont,this.ctx.fillStyle=t.colors.valueText,this.ctx.textAlign="center";const i=String(t.value);switch(t.valueLabelPosition){case"above":e=a-t.cursorLengthExtension-5,this.ctx.textBaseline="bottom";break;case"inside":e=a+t.pillHeight/2,this.ctx.textBaseline="middle";break;default:e=a+t.pillHeight+t.cursorLengthExtension+10,this.ctx.textBaseline="top"}this.ctx.fillText(i,f,e)}if(t.showZoneMinMaxLabels){const e=s(t.zoneMin),i=s(t.zoneMax);[{value:t.zoneMin,x:e,defaultAlign:"left"},{value:t.zoneMax,x:i,defaultAlign:"right"}].forEach((s=>{const o=String(s.value);this.ctx.font=t.zoneLabelFont;let r=t.zoneLabelColor;"#333333"===r&&"dark"===this.activePalette.name?r=this.activePalette.labelColor:r||(r=this.activePalette.labelColor||"#333333"),this.ctx.fillStyle=r;let l,n,h=s.x;const c=t.zoneOverflowAmount||0,d=t.zoneLabelOffset;switch(t.zoneLabelPosition){case"below":l=a+t.pillHeight+c+d,this.ctx.textBaseline="top",n="center";break;case"on":l=a+t.pillHeight/2,this.ctx.textBaseline="middle",s.x===e?(n="left",h=e+d):(n="right",h=i-d);break;default:l=a-c-d,this.ctx.textBaseline="bottom",n="center"}this.ctx.textAlign=n;const x=this.ctx.measureText(o),g=this.ctx.font.match(/(\d+)px/),f=g?parseInt(g[1],10):10,u=t.zoneLabelBackgroundPadding,p=x.width+2*u,b=f+2*u;let y,m;y="center"===n?h-p/2:"left"===n?h-u:h-x.width-u,m="top"===this.ctx.textBaseline?l-u:"bottom"===this.ctx.textBaseline?l-f-u:l-b/2;const A=t.zoneLabelBackgroundColor;A&&"transparent"!==A&&(this.ctx.fillStyle=A,this.ctx.fillRect(y,m,p,b)),this.ctx.fillStyle=r,this.ctx.fillText(o,h,l)}))}}}